# Building all outputs at once

In our analysis pipeline that we have constructed so far,
    we need to make two calls to snakemake to run all of our analysis:

1. `snakemake estimate_models` - to estimate OLS regressions
2. `snakemake make_figs` - to construct the figures

Whilst this is not too time consuming, it would be desirable to only have to run Snakemake once
    and have all our analysis in (1) and (2) be executed.
That is our next goal.

So that we are all starting from the same directory structure, let's clean our output directory,
    removing all estimated models and figures:
```{r, engine = 'bash', eval = FALSE}
$ snakemake clean
```
Now if we list the contents of the `out` directory and any potential subdirectories:
```{r, engine = 'bash', eval = FALSE}
$ ls -R out/
```
we see that there are no contents remaining:
```{r, engine = 'out', eval = FALSE}
out/:
```

## Creating an `all` rule

Out goal is to combine all the outputs from the `estimate_models` and `make_figs` rules.
Let's take a look at the structure of each of these rules so that we get a sense of what we might need to do.,
Here is the `estimate_models` rule:
```{r, engine = 'bash', eval = FALSE}
rule estimate_models:
    input:
        expand("out/analysis/{iModel}_ols_{iSubset}.rds",
                    iModel = MODELS,
                    iSubset = DATA_SUBSET)
```
And the `make_figs` rule:
```{r, engine = 'bash', eval = FALSE}
rule make_figs:
    input:
        expand("out/figures/{iFigure}.pdf",
                iFigure = FIGURES)
```

These rules have a common structure: both having only an `input`.
From other rules that we have written, we know that a rule can have multiple inputs if we name them.
This suggests a way forward.
We are going to create a new rule called `all` that contains two inputs^[#
    The name `all` is a convention, we could name it anything we please
]:

1. `figs`, which contains the inputs from our `make_figs` rule
2. `models`, which contains the inputs from our `estimate_models` rule

As ever, we will have to be mindful that if we have multiple inputs,
    have the trailing commas located wherever one input is followed by another.
Let's put this rule as the first in our Snakefile:
```{r, engine = 'bash', eval = FALSE}
# --- Build Rules --- #

rule all:
    input:
        figs   = expand("out/figures/{iFigure}.pdf",
                            iFigure = FIGURES),
        models = expand("out/analysis/{iModel}_ols_{iSubset}.rds",
                            iModel = MODELS,
                            iSubset = DATA_SUBSET)
```
