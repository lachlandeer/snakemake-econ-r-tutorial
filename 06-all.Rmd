# Building all outputs at once

In our analysis pipeline that we have constructed so far,
    we need to make two calls to snakemake to run all of our analysis:

1. `snakemake estimate_models` - to estimate OLS regressions
2. `snakemake make_figs` - to construct the figures

Whilst this is not too time consuming, it would be desirable to only have to run Snakemake once
    and have all our analysis in (1) and (2) be executed.
That is our next goal.

So that we are all starting from the same directory structure, let's clean our output directory,
    removing all estimated models and figures:
```{r, engine = 'bash', eval = FALSE}
$ snakemake clean
```
Now if we list the contents of the `out` directory and any potential subdirectories:
```{r, engine = 'bash', eval = FALSE}
$ ls -R out/
```
we see that there are no contents remaining:
```{r, engine = 'out', eval = FALSE}
out/:
```

## Creating an `all` rule

Out goal is to combine all the outputs from the `estimate_models` and `make_figs` rules.
Let's take a look at the structure of each of these rules so that we get a sense of what we might need to do.,
Here is the `estimate_models` rule:
```{r, engine = 'bash', eval = FALSE}
rule estimate_models:
    input:
        expand("out/analysis/{iModel}_ols_{iSubset}.rds",
                    iModel = MODELS,
                    iSubset = DATA_SUBSET)
```
And the `make_figs` rule:
```{r, engine = 'bash', eval = FALSE}
rule make_figs:
    input:
        expand("out/figures/{iFigure}.pdf",
                iFigure = FIGURES)
```

These rules have a common structure: both having only an `input`.
From other rules that we have written, we know that a rule can have multiple inputs if we name them.
This suggests a way forward.
We are going to create a new rule called `all` that contains two inputs,
    combining the inputs from the separate rules:^[
    The name `all` is a convention, we could name it anything we please
]:

1. `figs`, which contains the inputs from our `make_figs` rule
2. `models`, which contains the inputs from our `estimate_models` rule

As ever, we will have to be mindful that if we have multiple inputs,
    have the trailing commas located wherever one input is followed by another.
Let's put this rule as the first in our Snakefile:
```{r, engine = 'bash', eval = FALSE}
# --- Build Rules --- #

rule all:
    input:
        figs   = expand("out/figures/{iFigure}.pdf",
                            iFigure = FIGURES),
        models = expand("out/analysis/{iModel}_ols_{iSubset}.rds",
                            iModel = MODELS,
                            iSubset = DATA_SUBSET)
```

Let's check if this `all` rule does as desired - building all outputs.
If we run `snakemake --dryrun all`, we get the following output:

```{r, engine = 'out', eval = FALSE}
Building DAG of jobs...
Job counts:
	count	jobs
	1	all
	3	figures
	1	gen_regression_vars
	24	ols_model
	1	rename_vars
	30

[Tue Feb  5 16:23:01 2019]
rule rename_vars:
    input: src/data-management/rename_variables.R, src/data/mrw.dta
    output: out/data/mrw_renamed.csv
    jobid: 29


[Tue Feb  5 16:23:01 2019]
rule gen_regression_vars:
    input: src/data-management/gen_reg_vars.R, out/data/mrw_renamed.csv, src/data-specs/param_solow.json
    output: out/data/mrw_complete.csv
    jobid: 28


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_aug_cc.json, src/data-specs/subset_oecd.json
    output: out/analysis/model_aug_cc_ols_subset_oecd.rds
    jobid: 1
    wildcards: iModel=model_aug_cc, iSubset=subset_oecd


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_solow.json, src/data-specs/subset_oecd.json
    output: out/analysis/model_solow_ols_subset_oecd.rds
    jobid: 2
    wildcards: iModel=model_solow, iSubset=subset_oecd


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_solow_restr.json, src/data-specs/subset_oecd.json
    output: out/analysis/model_solow_restr_ols_subset_oecd.rds
    jobid: 4
    wildcards: iModel=model_solow_restr, iSubset=subset_oecd


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_cc.json, src/data-specs/subset_oecd.json
    output: out/analysis/model_cc_ols_subset_oecd.rds
    jobid: 5
    wildcards: iModel=model_cc, iSubset=subset_oecd


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_aug_cc_restr.json, src/data-specs/subset_intermediate.json
    output: out/analysis/model_aug_cc_restr_ols_subset_intermediate.rds
    jobid: 27
    wildcards: iModel=model_aug_cc_restr, iSubset=subset_intermediate


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_aug_solow.json, src/data-specs/subset_intermediate.json
    output: out/analysis/model_aug_solow_ols_subset_intermediate.rds
    jobid: 9
    wildcards: iModel=model_aug_solow, iSubset=subset_intermediate


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_aug_solow.json, src/data-specs/subset_nonoil.json
    output: out/analysis/model_aug_solow_ols_subset_nonoil.rds
    jobid: 13
    wildcards: iModel=model_aug_solow, iSubset=subset_nonoil


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_aug_cc_restr.json, src/data-specs/subset_nonoil.json
    output: out/analysis/model_aug_cc_restr_ols_subset_nonoil.rds
    jobid: 15
    wildcards: iModel=model_aug_cc_restr, iSubset=subset_nonoil


[Tue Feb  5 16:23:01 2019]
rule figures:
    input: src/figures/aug_conditional_convergence.R, out/data/mrw_complete.csv, src/data-specs/subset_intermediate.json
    output: out/figures/aug_conditional_convergence.pdf
    jobid: 18
    wildcards: iFigure=aug_conditional_convergence


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_ucc.json, src/data-specs/subset_oecd.json
    output: out/analysis/model_ucc_ols_subset_oecd.rds
    jobid: 25
    wildcards: iModel=model_ucc, iSubset=subset_oecd


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_aug_solow_restr.json, src/data-specs/subset_oecd.json
    output: out/analysis/model_aug_solow_restr_ols_subset_oecd.rds
    jobid: 26
    wildcards: iModel=model_aug_solow_restr, iSubset=subset_oecd


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_aug_cc_restr.json, src/data-specs/subset_oecd.json
    output: out/analysis/model_aug_cc_restr_ols_subset_oecd.rds
    jobid: 14
    wildcards: iModel=model_aug_cc_restr, iSubset=subset_oecd


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_aug_solow.json, src/data-specs/subset_oecd.json
    output: out/analysis/model_aug_solow_ols_subset_oecd.rds
    jobid: 3
    wildcards: iModel=model_aug_solow, iSubset=subset_oecd


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_solow.json, src/data-specs/subset_intermediate.json
    output: out/analysis/model_solow_ols_subset_intermediate.rds
    jobid: 7
    wildcards: iModel=model_solow, iSubset=subset_intermediate


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_cc.json, src/data-specs/subset_nonoil.json
    output: out/analysis/model_cc_ols_subset_nonoil.rds
    jobid: 23
    wildcards: iModel=model_cc, iSubset=subset_nonoil


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_solow_restr.json, src/data-specs/subset_intermediate.json
    output: out/analysis/model_solow_restr_ols_subset_intermediate.rds
    jobid: 10
    wildcards: iModel=model_solow_restr, iSubset=subset_intermediate


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_aug_cc.json, src/data-specs/subset_intermediate.json
    output: out/analysis/model_aug_cc_ols_subset_intermediate.rds
    jobid: 11
    wildcards: iModel=model_aug_cc, iSubset=subset_intermediate


[Tue Feb  5 16:23:01 2019]
rule figures:
    input: src/figures/unconditional_convergence.R, out/data/mrw_complete.csv, src/data-specs/subset_intermediate.json
    output: out/figures/unconditional_convergence.pdf
    jobid: 24
    wildcards: iFigure=unconditional_convergence


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_cc.json, src/data-specs/subset_intermediate.json
    output: out/analysis/model_cc_ols_subset_intermediate.rds
    jobid: 8
    wildcards: iModel=model_cc, iSubset=subset_intermediate


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_solow_restr.json, src/data-specs/subset_nonoil.json
    output: out/analysis/model_solow_restr_ols_subset_nonoil.rds
    jobid: 12
    wildcards: iModel=model_solow_restr, iSubset=subset_nonoil


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_solow.json, src/data-specs/subset_nonoil.json
    output: out/analysis/model_solow_ols_subset_nonoil.rds
    jobid: 16
    wildcards: iModel=model_solow, iSubset=subset_nonoil


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_aug_cc.json, src/data-specs/subset_nonoil.json
    output: out/analysis/model_aug_cc_ols_subset_nonoil.rds
    jobid: 17
    wildcards: iModel=model_aug_cc, iSubset=subset_nonoil


[Tue Feb  5 16:23:01 2019]
rule figures:
    input: src/figures/conditional_convergence.R, out/data/mrw_complete.csv, src/data-specs/subset_intermediate.json
    output: out/figures/conditional_convergence.pdf
    jobid: 19
    wildcards: iFigure=conditional_convergence


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_ucc.json, src/data-specs/subset_intermediate.json
    output: out/analysis/model_ucc_ols_subset_intermediate.rds
    jobid: 20
    wildcards: iModel=model_ucc, iSubset=subset_intermediate


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_aug_solow_restr.json, src/data-specs/subset_nonoil.json
    output: out/analysis/model_aug_solow_restr_ols_subset_nonoil.rds
    jobid: 21
    wildcards: iModel=model_aug_solow_restr, iSubset=subset_nonoil


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_ucc.json, src/data-specs/subset_nonoil.json
    output: out/analysis/model_ucc_ols_subset_nonoil.rds
    jobid: 22
    wildcards: iModel=model_ucc, iSubset=subset_nonoil


[Tue Feb  5 16:23:01 2019]
rule ols_model:
    input: src/analysis/estimate_ols_model.R, out/data/mrw_complete.csv, src/model-specs/model_aug_solow_restr.json, src/data-specs/subset_intermediate.json
    output: out/analysis/model_aug_solow_restr_ols_subset_intermediate.rds
    jobid: 6
    wildcards: iModel=model_aug_solow_restr, iSubset=subset_intermediate


[Tue Feb  5 16:23:01 2019]
localrule all:
    input: out/figures/conditional_convergence.pdf, out/figures/unconditional_convergence.pdf, out/figures/aug_conditional_convergence.pdf, out/analysis/model_solow_ols_subset_oecd.rds, out/analysis/model_aug_cc_restr_ols_subset_oecd.rds, out/analysis/model_solow_restr_ols_subset_oecd.rds, out/analysis/model_cc_ols_subset_oecd.rds, out/analysis/model_ucc_ols_subset_oecd.rds, out/analysis/model_aug_solow_restr_ols_subset_oecd.rds, out/analysis/model_aug_cc_ols_subset_oecd.rds, out/analysis/model_aug_solow_ols_subset_oecd.rds, out/analysis/model_solow_ols_subset_nonoil.rds, out/analysis/model_aug_cc_restr_ols_subset_nonoil.rds, out/analysis/model_solow_restr_ols_subset_nonoil.rds, out/analysis/model_cc_ols_subset_nonoil.rds, out/analysis/model_ucc_ols_subset_nonoil.rds, out/analysis/model_aug_solow_restr_ols_subset_nonoil.rds, out/analysis/model_aug_cc_ols_subset_nonoil.rds, out/analysis/model_aug_solow_ols_subset_nonoil.rds, out/analysis/model_solow_ols_subset_intermediate.rds, out/analysis/model_aug_cc_restr_ols_subset_intermediate.rds, out/analysis/model_solow_restr_ols_subset_intermediate.rds, out/analysis/model_cc_ols_subset_intermediate.rds, out/analysis/model_ucc_ols_subset_intermediate.rds, out/analysis/model_aug_solow_restr_ols_subset_intermediate.rds, out/analysis/model_aug_cc_ols_subset_intermediate.rds, out/analysis/model_aug_solow_ols_subset_intermediate.rds
    jobid: 0

Job counts:
	count	jobs
	1	all
	3	figures
	1	gen_regression_vars
	24	ols_model
	1	rename_vars
	30

```

The output shows that we have achieved our desired goal.
The `all` rule builds all outputs.
Notice that if you examine the order that Snakemake plans to execute the jobs that:

1. First the data management steps are executed to prepare data
    * This is what we would expect, as we cannot do any analysis without cleaned data
2. The order in which the figures and regressions are executed are mixed together
    * This is because the figures and regression outputs do not depend on each other

Now we build our entire project^[
    Notice that we placed the `all` rule as the first rule in our Snakefile.
    Snakemake's default behaviour is to build the first rule in the file,
        so we could instead type only `snakemake` and get the same result.
]:
```{r, engine = 'bash', eval = FALSE}
$ snakemake all
```
