<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Pattern Rules | Reproducible Data Analytic Workflows with Snakemake and R</title>
  <meta name="description" content="In progress" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Pattern Rules | Reproducible Data Analytic Workflows with Snakemake and R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="In progress" />
  <meta name="github-repo" content="lachlandeer/snakemake-econ-r-tutorial" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Pattern Rules | Reproducible Data Analytic Workflows with Snakemake and R" />
  
  <meta name="twitter:description" content="In progress" />
  

<meta name="author" content="Ulrich Bergmann" />
<meta name="author" content="Lachlan Deer" />
<meta name="author" content="Julian Langer" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="working-with-multiple-rules.html"/>
<link rel="next" href="automatic-wildcard-specifications.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./index.html">Reproducible Data Analytic Workflows with Snakemake and `R`</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#why-we-wrote-this-tutorial"><i class="fa fa-check"></i>Why we wrote this tutorial</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#pre-requisite-knowledge"><i class="fa fa-check"></i>Pre-requisite Knowledge</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-needs-to-be-downloaded-installed-for-this-tutorial"><i class="fa fa-check"></i>What Needs to be Downloaded &amp; Installed for this Tutorial</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#template-scripts-and-documents"><i class="fa fa-check"></i>Template Scripts and Documents</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#software-installation"><i class="fa fa-check"></i>Software Installation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-we-cant-cover"><i class="fa fa-check"></i>What We Can’t Cover</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-authors"><i class="fa fa-check"></i>About the Authors</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#instructional-material"><i class="fa fa-check"></i>Instructional material</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#software"><i class="fa fa-check"></i>Software</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#citation"><i class="fa fa-check"></i>Citation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="part-i-preliminaries.html"><a href="part-i-preliminaries.html"><i class="fa fa-check"></i>PART I - Preliminaries</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Motivating &amp; Rationale</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#a-case-for-reproducibility"><i class="fa fa-check"></i><b>1.1</b> A Case for Reproducibility</a><ul>
<li class="chapter" data-level="1.1.1" data-path="intro.html"><a href="intro.html#how-far-to-go-in-the-quest-for-reproducibility"><i class="fa fa-check"></i><b>1.1.1</b> How far to go in the quest for reproducibility?</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#what-is-snakemake-why-should-you-use-it"><i class="fa fa-check"></i><b>1.2</b> What is <code>Snakemake</code> &amp; Why Should you use it?</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#why-r"><i class="fa fa-check"></i><b>1.3</b> Why <code>R</code>?</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#working-example-replicating-mankiw-romer-and-weils-1992-qje"><i class="fa fa-check"></i><b>1.4</b> Working Example: Replicating Mankiw, Romer and Weil’s 1992 QJE</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#the-way-forward"><i class="fa fa-check"></i><b>1.5</b> The way forward</a><ul>
<li class="chapter" data-level="" data-path="intro.html"><a href="intro.html#exercise-your-own-projects-steps"><i class="fa fa-check"></i>Exercise: Your own project’s steps</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="project-organization.html"><a href="project-organization.html"><i class="fa fa-check"></i><b>2</b> Project Organization</a><ul>
<li class="chapter" data-level="" data-path="project-organization.html"><a href="project-organization.html#learning-objectives"><i class="fa fa-check"></i>Learning Objectives</a></li>
<li class="chapter" data-level="2.1" data-path="project-organization.html"><a href="project-organization.html#subtitle-tbd"><i class="fa fa-check"></i><b>2.1</b> Subtitle TBD</a></li>
<li class="chapter" data-level="2.2" data-path="project-organization.html"><a href="project-organization.html#project-organization-i-separating-inputs-and-outputs"><i class="fa fa-check"></i><b>2.2</b> Project Organization I: Separating Inputs and Outputs</a></li>
<li class="chapter" data-level="2.3" data-path="project-organization.html"><a href="project-organization.html#project-structure-ii-separating-logical-chunks-of-the-project"><i class="fa fa-check"></i><b>2.3</b> Project Structure II: Separating Logical Chunks of the Project</a><ul>
<li class="chapter" data-level="2.3.1" data-path="project-organization.html"><a href="project-organization.html#aside-even-deeper-sub-folders"><i class="fa fa-check"></i><b>2.3.1</b> Aside: Even Deeper Sub-folders</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="project-organization.html"><a href="project-organization.html#project-structure-iii-separating-input-parameters-from-code"><i class="fa fa-check"></i><b>2.4</b> Project Structure III: Separating Input Parameters from Code</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html"><i class="fa fa-check"></i><b>3</b> Initial Steps with Snakemake</a><ul>
<li class="chapter" data-level="3.1" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#snakefile-writing-our-first-rule"><i class="fa fa-check"></i><b>3.1</b> Snakefile – Writing Our First Rule</a></li>
<li class="chapter" data-level="3.2" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#the-snakemake-command-executing-a-rule"><i class="fa fa-check"></i><b>3.2</b> The Snakemake Command – Executing a Rule</a></li>
<li class="chapter" data-level="3.3" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#reading-and-writing-files-first-steps-in-a-data-science-pipeline"><i class="fa fa-check"></i><b>3.3</b> Reading and Writing Files – First Steps in a Data Science Pipeline</a><ul>
<li class="chapter" data-level="3.3.1" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#using-the-rscript-command-to-execute-r-scripts"><i class="fa fa-check"></i><b>3.3.1</b> Using the Rscript command to execute R scripts</a></li>
<li class="chapter" data-level="3.3.2" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#the-input-and-output-arguments"><i class="fa fa-check"></i><b>3.3.2</b> The input and output arguments</a></li>
<li class="chapter" data-level="3.3.3" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#a-rule-to-rename-variables."><i class="fa fa-check"></i><b>3.3.3</b> A rule to rename variables.</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#redundant-executions-dont-run-a-rule-repeatedly"><i class="fa fa-check"></i><b>3.4</b> Redundant Executions – (Don’t) Run a Rule Repeatedly</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="working-with-multiple-rules.html"><a href="working-with-multiple-rules.html"><i class="fa fa-check"></i><b>4</b> Working With Multiple Rules</a><ul>
<li class="chapter" data-level="4.1" data-path="working-with-multiple-rules.html"><a href="working-with-multiple-rules.html#creating-a-second-rule"><i class="fa fa-check"></i><b>4.1</b> Creating a second rule</a><ul>
<li class="chapter" data-level="" data-path="working-with-multiple-rules.html"><a href="working-with-multiple-rules.html#exercise-creating-rules"><i class="fa fa-check"></i>Exercise: Creating Rules</a></li>
<li class="chapter" data-level="" data-path="working-with-multiple-rules.html"><a href="working-with-multiple-rules.html#solution"><i class="fa fa-check"></i>Solution</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="working-with-multiple-rules.html"><a href="working-with-multiple-rules.html#clean-rules"><i class="fa fa-check"></i><b>4.2</b> Clean Rules</a><ul>
<li class="chapter" data-level="" data-path="working-with-multiple-rules.html"><a href="working-with-multiple-rules.html#exercise-creating-cleaning-rules"><i class="fa fa-check"></i>Exercise: Creating Cleaning Rules</a></li>
<li class="chapter" data-level="" data-path="working-with-multiple-rules.html"><a href="working-with-multiple-rules.html#solution-1"><i class="fa fa-check"></i>Solution</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="pattern-rules.html"><a href="pattern-rules.html"><i class="fa fa-check"></i><b>5</b> Pattern Rules</a><ul>
<li class="chapter" data-level="5.1" data-path="pattern-rules.html"><a href="pattern-rules.html#how-snakemake-determines-the-build-order-when-multiple-rules-are-present"><i class="fa fa-check"></i><b>5.1</b> How Snakemake determines the build order when multiple rules are present</a></li>
<li class="chapter" data-level="5.2" data-path="pattern-rules.html"><a href="pattern-rules.html#where-we-are-now"><i class="fa fa-check"></i><b>5.2</b> Where we are now?</a></li>
<li class="chapter" data-level="5.3" data-path="pattern-rules.html"><a href="pattern-rules.html#the-expand-function"><i class="fa fa-check"></i><b>5.3</b> The <code>expand()</code> function</a><ul>
<li class="chapter" data-level="" data-path="pattern-rules.html"><a href="pattern-rules.html#exercise-exploring-the-expand-function-i"><i class="fa fa-check"></i>Exercise: Exploring the expand() function I</a></li>
<li class="chapter" data-level="" data-path="pattern-rules.html"><a href="pattern-rules.html#exercise-exploring-the-expand-function-ii"><i class="fa fa-check"></i>Exercise: Exploring the expand function II</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="pattern-rules.html"><a href="pattern-rules.html#expanding-multiple-wildcards"><i class="fa fa-check"></i><b>5.4</b> Expanding Multiple Wildcards</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="automatic-wildcard-specifications.html"><a href="automatic-wildcard-specifications.html"><i class="fa fa-check"></i><b>6</b> Automatic Wildcard Specifications</a><ul>
<li class="chapter" data-level="6.1" data-path="automatic-wildcard-specifications.html"><a href="automatic-wildcard-specifications.html#the-glob_wildcards-function"><i class="fa fa-check"></i><b>6.1</b> The <code>glob_wildcards</code> Function</a><ul>
<li class="chapter" data-level="" data-path="automatic-wildcard-specifications.html"><a href="automatic-wildcard-specifications.html#exercise-exploring-glob_wildcards"><i class="fa fa-check"></i>Exercise: Exploring glob_wildcards()</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="automatic-wildcard-specifications.html"><a href="automatic-wildcard-specifications.html#further-restricting-the-glob_wildcards-output"><i class="fa fa-check"></i><b>6.2</b> Further Restricting the <code>glob_wildcards</code> output</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="building-all-outputs-at-once.html"><a href="building-all-outputs-at-once.html"><i class="fa fa-check"></i><b>7</b> Building all outputs at once</a><ul>
<li class="chapter" data-level="7.1" data-path="building-all-outputs-at-once.html"><a href="building-all-outputs-at-once.html#creating-an-all-rule"><i class="fa fa-check"></i><b>7.1</b> Creating an <code>all</code> rule</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="adding-parameters.html"><a href="adding-parameters.html"><i class="fa fa-check"></i><b>8</b> Adding Parameters</a><ul>
<li class="chapter" data-level="8.1" data-path="adding-parameters.html"><a href="adding-parameters.html#motivating-example-constructing-a-regression-table-from-ols-results"><i class="fa fa-check"></i><b>8.1</b> Motivating Example: Constructing a Regression Table from OLS Results</a></li>
<li class="chapter" data-level="8.2" data-path="adding-parameters.html"><a href="adding-parameters.html#creating-a-rule-with-params"><i class="fa fa-check"></i><b>8.2</b> Creating a Rule with <code>params</code></a><ul>
<li class="chapter" data-level="" data-path="adding-parameters.html"><a href="adding-parameters.html#exercise-building-table-2"><i class="fa fa-check"></i>Exercise: Building Table 2</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="part-ii.html"><a href="part-ii.html"><i class="fa fa-check"></i>PART II</a></li>
<li class="chapter" data-level="9" data-path="logging-output-and-errors.html"><a href="logging-output-and-errors.html"><i class="fa fa-check"></i><b>9</b> Logging Output and Errors</a><ul>
<li class="chapter" data-level="9.1" data-path="logging-output-and-errors.html"><a href="logging-output-and-errors.html#logging-output"><i class="fa fa-check"></i><b>9.1</b> Logging Output</a></li>
<li class="chapter" data-level="9.2" data-path="logging-output-and-errors.html"><a href="logging-output-and-errors.html#logging-output-and-errors-in-one-file"><i class="fa fa-check"></i><b>9.2</b> Logging Output and Errors in One File</a><ul>
<li class="chapter" data-level="" data-path="logging-output-and-errors.html"><a href="logging-output-and-errors.html#exercise-logging-all-r-scripts"><i class="fa fa-check"></i>Exercise: Logging all R Scripts</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="self-documenting-help.html"><a href="self-documenting-help.html"><i class="fa fa-check"></i><b>10</b> Self Documenting Help</a><ul>
<li class="chapter" data-level="10.1" data-path="self-documenting-help.html"><a href="self-documenting-help.html#our-commenting-syle"><i class="fa fa-check"></i><b>10.1</b> Our Commenting Syle</a></li>
<li class="chapter" data-level="10.2" data-path="self-documenting-help.html"><a href="self-documenting-help.html#adding-further-comments"><i class="fa fa-check"></i><b>10.2</b> Adding Further Comments</a><ul>
<li class="chapter" data-level="" data-path="self-documenting-help.html"><a href="self-documenting-help.html#exercise-adding-comments"><i class="fa fa-check"></i>Exercise: Adding Comments</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="self-documenting-help.html"><a href="self-documenting-help.html#a-help-rule"><i class="fa fa-check"></i><b>10.3</b> A <code>help</code> Rule</a><ul>
<li><a href="self-documenting-help.html#exercise-saving-help-output-to-file">Exercise: Saving <code>help</code> output to file</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="config-files.html"><a href="config-files.html"><i class="fa fa-check"></i><b>11</b> Config Files</a><ul>
<li class="chapter" data-level="11.1" data-path="config-files.html"><a href="config-files.html#the-config.yaml-filepath"><i class="fa fa-check"></i><b>11.1</b> The <code>config.yaml</code> filepath</a></li>
<li class="chapter" data-level="11.2" data-path="config-files.html"><a href="config-files.html#using-paths-from-the-config-file"><i class="fa fa-check"></i><b>11.2</b> Using paths from the config file</a><ul>
<li class="chapter" data-level="" data-path="config-files.html"><a href="config-files.html#exercise-using-config-files"><i class="fa fa-check"></i>Exercise: Using Config Files</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="subworkflows-divide-and-conquer.html"><a href="subworkflows-divide-and-conquer.html"><i class="fa fa-check"></i><b>12</b> Subworkflows: Divide and Conquer</a><ul>
<li class="chapter" data-level="12.1" data-path="subworkflows-divide-and-conquer.html"><a href="subworkflows-divide-and-conquer.html#subworkflow-basics"><i class="fa fa-check"></i><b>12.1</b> Subworkflow Basics</a></li>
<li class="chapter" data-level="12.2" data-path="subworkflows-divide-and-conquer.html"><a href="subworkflows-divide-and-conquer.html#subworkflow-dependencies"><i class="fa fa-check"></i><b>12.2</b> Subworkflow dependencies</a><ul>
<li class="chapter" data-level="" data-path="subworkflows-divide-and-conquer.html"><a href="subworkflows-divide-and-conquer.html#exercise-more-subworkflows"><i class="fa fa-check"></i>Exercise: More Subworkflows</a></li>
<li><a href="subworkflows-divide-and-conquer.html#guided-exercise-help-rules-with-subworkflows">Guided Exercise: <code>help</code> rules with subworkflows</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="part-iii.html"><a href="part-iii.html"><i class="fa fa-check"></i>PART III</a></li>
<li class="chapter" data-level="13" data-path="reproducible-articles-with-rmd.html"><a href="reproducible-articles-with-rmd.html"><i class="fa fa-check"></i><b>13</b> Reproducible Articles with Rmd</a></li>
<li class="chapter" data-level="14" data-path="reproducible-slides-with-rmd.html"><a href="reproducible-slides-with-rmd.html"><i class="fa fa-check"></i><b>14</b> Reproducible Slides with Rmd</a></li>
<li class="chapter" data-level="15" data-path="package-dependencies-with-packrat.html"><a href="package-dependencies-with-packrat.html"><i class="fa fa-check"></i><b>15</b> Package Dependencies with Packrat</a></li>
<li class="chapter" data-level="16" data-path="containers.html"><a href="containers.html"><i class="fa fa-check"></i><b>16</b> Containers</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Reproducible Data Analytic Workflows with Snakemake and <code>R</code></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="pattern-rules" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> Pattern Rules</h1>
<div id="how-snakemake-determines-the-build-order-when-multiple-rules-are-present" class="section level2">
<h2><span class="header-section-number">5.1</span> How Snakemake determines the build order when multiple rules are present</h2>
<p>Now that we have worked with multiple rules and seen how rules can call other rules, let us try to understand the principle behind this.</p>
<p>As we know, we can execute any rule in <code>Snakefile</code> explicitly by calling it by name like so:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb64-1"><a href="pattern-rules.html#cb64-1"></a><span class="ex">snakemake</span> --cores 1 solow_intermediate</span></code></pre></div>
<p>When no rule name is explicitly given, Snakemake will execute the first rule it encounters at the top of <code>Snakefile</code>:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb65-1"><a href="pattern-rules.html#cb65-1"></a><span class="ex">snakemake</span> --cores 1</span></code></pre></div>
<p>If you followed the order of rules in the solution to the previous exercise, <code>solow_intermediate</code> is the first rule in <code>Snakefile</code>.
In this case, command are equivalent.</p>
<p>The rule we ask <code>Snakemkake</code> to execute either explicitly or implicitly is called a <strong>target rule</strong>.</p>
<p>If all necessary inputs to build the target rule exist, Snakemake will execute the rule and build the defined outputs.</p>
<p>When Snakemake recognizes that a necessary <code>input</code> to execute the target rule is missing, Snakemake will try to build it through the other rules present in <code>Snakefile</code>.</p>
<p>To illustrate this, let us stick to our present project and assume the target rule is <code>solow_intermediate</code>.
The following graph shows all rules which lead up to the target rule:</p>
<div class="figure">
<embed src="img/filegraph.pdf" />
<p class="caption">filegraph</p>
</div>
<p><code>mrw_complete.csv</code> is a necessary input to <code>solow_intermediate</code>.
If the file does not exist, <code>Snakemake</code> will search through <code>Snakefile</code> for another rule which has <code>mrw_complete.csv</code> as its output – in our case <code>gen_regression_vars</code>.
In this case, Snakemake will first execute <code>gen_regression_vars</code> before executing the target rule <code>solow_intermediate</code>.</p>
<p>If necessary inputs are missing to execute <code>gen_regression_vars</code>, Snakemake will search for other rules to produce it and so forth…</p>
<p>To allow Snakemake to do work properly, the input and output relationships in a project need to follow a <strong>directed acyclic graph (DAG)</strong>.
Directed here means that….
Acyclic implies that there can be no two rules which require output from one another as inputs, either directly or in a larger loop.</p>
<p>This has a few implications on how we should define our intermediate input and output files.
We should follow the following rules to prevent problems:</p>
<ul>
<li><strong>No rule should have use the same file as input and output.</strong> It is often common practice to load a certain dataset, perform operations on it and overwrite the original file. While there are good reasons to never do this in any workflow, this behavior can lead to more severe problems when using Snakemake. Snakemake only seaches for rules which can create input files which do not yet exist. If a rule overwrites an already existing input file, Snakemake would not execute it as a dependency for a downstream target rule and the changes of such a rule would not be reflected in the outputs of the target rule. For this reason, <code>gen_regression_vars</code> writes its results to a new file in this project.</li>
<li><strong>No two rules should have the same output.</strong> When Snakemake searches for a file to create a necessary input, it will execute the first rule it encounters which produces the file. To make input and output relationships explicit and reproducible, we do not want to let this be determined by chance.</li>
<li><strong>A project should have a clear direction.</strong> The projects needs to be directed which implies that the execution of a project should have a clear trajetory. In practice this typically starts with data manipulations which are necessary to perform analysis, which in turn will be used to create plots and tables, which finally end up in a paper or set of slides.
Directedness here for example implies that the regression table cannot be an input to data manipulations etc.</li>
<li><strong>A project cannot be circular.</strong> Any circularity would let Snakemake search for rules in an infinite loop.</li>
</ul>
</div>
<div id="where-we-are-now" class="section level2">
<h2><span class="header-section-number">5.2</span> Where we are now?</h2>
<p>If you still have the <code>hello_world</code> rule in your Snakefile, now is a good moment to remove it.
Then, your Snakefile should look something like this:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb66-1"><a href="pattern-rules.html#cb66-1"></a><span class="co">## Snakemake - MRW Replication</span></span>
<span id="cb66-2"><a href="pattern-rules.html#cb66-2"></a><span class="co">##</span></span>
<span id="cb66-3"><a href="pattern-rules.html#cb66-3"></a><span class="co">## @yourname</span></span>
<span id="cb66-4"><a href="pattern-rules.html#cb66-4"></a></span>
<span id="cb66-5"><a href="pattern-rules.html#cb66-5"></a></span>
<span id="cb66-6"><a href="pattern-rules.html#cb66-6"></a><span class="co"># --- Build Rules --- #</span></span>
<span id="cb66-7"><a href="pattern-rules.html#cb66-7"></a></span>
<span id="cb66-8"><a href="pattern-rules.html#cb66-8"></a><span class="ex">rule</span> solow_intermediate:</span>
<span id="cb66-9"><a href="pattern-rules.html#cb66-9"></a>    <span class="ex">input</span>:</span>
<span id="cb66-10"><a href="pattern-rules.html#cb66-10"></a>        <span class="ex">script</span>   = <span class="st">&quot;src/analysis/estimate_ols_model.R&quot;</span>,</span>
<span id="cb66-11"><a href="pattern-rules.html#cb66-11"></a>        <span class="ex">data</span>     = <span class="st">&quot;out/data/mrw_complete.csv&quot;</span>,</span>
<span id="cb66-12"><a href="pattern-rules.html#cb66-12"></a>        <span class="ex">model</span>    = <span class="st">&quot;src/model-specs/model_solow.json&quot;</span>,</span>
<span id="cb66-13"><a href="pattern-rules.html#cb66-13"></a>        <span class="ex">subset</span>   = <span class="st">&quot;src/data-specs/subset_intermediate.json&quot;</span></span>
<span id="cb66-14"><a href="pattern-rules.html#cb66-14"></a>    <span class="ex">output</span>:</span>
<span id="cb66-15"><a href="pattern-rules.html#cb66-15"></a>        <span class="ex">estimate</span> = <span class="st">&quot;out/analysis/model_solow_subset_intermediate.rds&quot;</span>,</span>
<span id="cb66-16"><a href="pattern-rules.html#cb66-16"></a>    <span class="ex">shell</span>:</span>
<span id="cb66-17"><a href="pattern-rules.html#cb66-17"></a>        <span class="st">&quot;Rscript {input.script} \</span></span>
<span id="cb66-18"><a href="pattern-rules.html#cb66-18"></a><span class="st">            --data {input.data} \</span></span>
<span id="cb66-19"><a href="pattern-rules.html#cb66-19"></a><span class="st">            --model {input.model} \</span></span>
<span id="cb66-20"><a href="pattern-rules.html#cb66-20"></a><span class="st">            --subset {input.subset} \</span></span>
<span id="cb66-21"><a href="pattern-rules.html#cb66-21"></a><span class="st">            --out {output.estimate}&quot;</span></span>
<span id="cb66-22"><a href="pattern-rules.html#cb66-22"></a></span>
<span id="cb66-23"><a href="pattern-rules.html#cb66-23"></a><span class="ex">rule</span> solow_nonoil:</span>
<span id="cb66-24"><a href="pattern-rules.html#cb66-24"></a>    <span class="ex">input</span>:</span>
<span id="cb66-25"><a href="pattern-rules.html#cb66-25"></a>        <span class="ex">script</span>   = <span class="st">&quot;src/analysis/estimate_ols_model.R&quot;</span>,</span>
<span id="cb66-26"><a href="pattern-rules.html#cb66-26"></a>        <span class="ex">data</span>     = <span class="st">&quot;out/data/mrw_complete.csv&quot;</span>,</span>
<span id="cb66-27"><a href="pattern-rules.html#cb66-27"></a>        <span class="ex">model</span>    = <span class="st">&quot;src/model-specs/model_solow.json&quot;</span>,</span>
<span id="cb66-28"><a href="pattern-rules.html#cb66-28"></a>        <span class="ex">subset</span>   = <span class="st">&quot;src/data-specs/subset_nonoil.json&quot;</span></span>
<span id="cb66-29"><a href="pattern-rules.html#cb66-29"></a>    <span class="ex">output</span>:</span>
<span id="cb66-30"><a href="pattern-rules.html#cb66-30"></a>        <span class="ex">estimate</span> = <span class="st">&quot;out/analysis/model_solow_subset_nonoil.rds&quot;</span>,</span>
<span id="cb66-31"><a href="pattern-rules.html#cb66-31"></a>    <span class="ex">shell</span>:</span>
<span id="cb66-32"><a href="pattern-rules.html#cb66-32"></a>        <span class="st">&quot;Rscript {input.script} \</span></span>
<span id="cb66-33"><a href="pattern-rules.html#cb66-33"></a><span class="st">            --data {input.data} \</span></span>
<span id="cb66-34"><a href="pattern-rules.html#cb66-34"></a><span class="st">            --model {input.model} \</span></span>
<span id="cb66-35"><a href="pattern-rules.html#cb66-35"></a><span class="st">            --subset {input.subset} \</span></span>
<span id="cb66-36"><a href="pattern-rules.html#cb66-36"></a><span class="st">            --out {output.estimate}&quot;</span></span>
<span id="cb66-37"><a href="pattern-rules.html#cb66-37"></a></span>
<span id="cb66-38"><a href="pattern-rules.html#cb66-38"></a><span class="ex">rule</span> solow_oecd:</span>
<span id="cb66-39"><a href="pattern-rules.html#cb66-39"></a>    <span class="ex">input</span>:</span>
<span id="cb66-40"><a href="pattern-rules.html#cb66-40"></a>        <span class="ex">script</span>   = <span class="st">&quot;src/analysis/estimate_ols_model.R&quot;</span>,</span>
<span id="cb66-41"><a href="pattern-rules.html#cb66-41"></a>        <span class="ex">data</span>     = <span class="st">&quot;out/data/mrw_complete.csv&quot;</span>,</span>
<span id="cb66-42"><a href="pattern-rules.html#cb66-42"></a>        <span class="ex">model</span>    = <span class="st">&quot;src/model-specs/model_solow.json&quot;</span>,</span>
<span id="cb66-43"><a href="pattern-rules.html#cb66-43"></a>        <span class="ex">subset</span>   = <span class="st">&quot;src/data-specs/subset_oecd.json&quot;</span></span>
<span id="cb66-44"><a href="pattern-rules.html#cb66-44"></a>    <span class="ex">output</span>:</span>
<span id="cb66-45"><a href="pattern-rules.html#cb66-45"></a>        <span class="ex">estimate</span> = <span class="st">&quot;out/analysis/model_solow_subset_oecd.rds&quot;</span>,</span>
<span id="cb66-46"><a href="pattern-rules.html#cb66-46"></a>    <span class="ex">shell</span>:</span>
<span id="cb66-47"><a href="pattern-rules.html#cb66-47"></a>        <span class="st">&quot;Rscript {input.script} \</span></span>
<span id="cb66-48"><a href="pattern-rules.html#cb66-48"></a><span class="st">            --data {input.data} \</span></span>
<span id="cb66-49"><a href="pattern-rules.html#cb66-49"></a><span class="st">            --model {input.model} \</span></span>
<span id="cb66-50"><a href="pattern-rules.html#cb66-50"></a><span class="st">            --subset {input.subset} \</span></span>
<span id="cb66-51"><a href="pattern-rules.html#cb66-51"></a><span class="st">            --out {output.estimate}&quot;</span></span>
<span id="cb66-52"><a href="pattern-rules.html#cb66-52"></a></span>
<span id="cb66-53"><a href="pattern-rules.html#cb66-53"></a><span class="ex">rule</span> gen_regression_vars:</span>
<span id="cb66-54"><a href="pattern-rules.html#cb66-54"></a>    <span class="ex">input</span>:</span>
<span id="cb66-55"><a href="pattern-rules.html#cb66-55"></a>        <span class="ex">script</span> = <span class="st">&quot;src/data-management/gen_reg_vars.R&quot;</span>,</span>
<span id="cb66-56"><a href="pattern-rules.html#cb66-56"></a>        <span class="ex">data</span>   = <span class="st">&quot;out/data/mrw_renamed.csv&quot;</span></span>
<span id="cb66-57"><a href="pattern-rules.html#cb66-57"></a>    <span class="ex">output</span>:</span>
<span id="cb66-58"><a href="pattern-rules.html#cb66-58"></a>        <span class="ex">data</span>   = <span class="st">&quot;out/data/mrw_complete.csv&quot;</span></span>
<span id="cb66-59"><a href="pattern-rules.html#cb66-59"></a>    <span class="ex">shell</span>:</span>
<span id="cb66-60"><a href="pattern-rules.html#cb66-60"></a>        <span class="st">&quot;Rscript {input.script} \</span></span>
<span id="cb66-61"><a href="pattern-rules.html#cb66-61"></a><span class="st">            --data {input.data} \</span></span>
<span id="cb66-62"><a href="pattern-rules.html#cb66-62"></a><span class="st">            --out {output.data}&quot;</span></span>
<span id="cb66-63"><a href="pattern-rules.html#cb66-63"></a></span>
<span id="cb66-64"><a href="pattern-rules.html#cb66-64"></a><span class="ex">rule</span> rename_vars:</span>
<span id="cb66-65"><a href="pattern-rules.html#cb66-65"></a>    <span class="ex">input</span>:</span>
<span id="cb66-66"><a href="pattern-rules.html#cb66-66"></a>        <span class="ex">script</span> = <span class="st">&quot;src/data-management/rename_variables.R&quot;</span>,</span>
<span id="cb66-67"><a href="pattern-rules.html#cb66-67"></a>        <span class="ex">data</span>   = <span class="st">&quot;src/data/mrw.dta&quot;</span></span>
<span id="cb66-68"><a href="pattern-rules.html#cb66-68"></a>    <span class="ex">output</span>:</span>
<span id="cb66-69"><a href="pattern-rules.html#cb66-69"></a>        <span class="ex">data</span> = <span class="st">&quot;out/data/mrw_renamed.csv&quot;</span></span>
<span id="cb66-70"><a href="pattern-rules.html#cb66-70"></a>    <span class="ex">shell</span>:</span>
<span id="cb66-71"><a href="pattern-rules.html#cb66-71"></a>        <span class="st">&quot;Rscript {input.script} \</span></span>
<span id="cb66-72"><a href="pattern-rules.html#cb66-72"></a><span class="st">            --data {input.data} \</span></span>
<span id="cb66-73"><a href="pattern-rules.html#cb66-73"></a><span class="st">            --out {output.data}&quot;</span></span>
<span id="cb66-74"><a href="pattern-rules.html#cb66-74"></a></span>
<span id="cb66-75"><a href="pattern-rules.html#cb66-75"></a><span class="co"># --- Clean Rules --- #</span></span>
<span id="cb66-76"><a href="pattern-rules.html#cb66-76"></a></span>
<span id="cb66-77"><a href="pattern-rules.html#cb66-77"></a><span class="ex">rule</span> clean:</span>
<span id="cb66-78"><a href="pattern-rules.html#cb66-78"></a>    <span class="ex">shell</span>:</span>
<span id="cb66-79"><a href="pattern-rules.html#cb66-79"></a>        <span class="st">&quot;rm -rf out/*&quot;</span></span>
<span id="cb66-80"><a href="pattern-rules.html#cb66-80"></a></span>
<span id="cb66-81"><a href="pattern-rules.html#cb66-81"></a><span class="ex">rule</span> clean_data:</span>
<span id="cb66-82"><a href="pattern-rules.html#cb66-82"></a>    <span class="ex">shell</span>:</span>
<span id="cb66-83"><a href="pattern-rules.html#cb66-83"></a>        <span class="st">&quot;rm -rf out/data/*&quot;</span></span>
<span id="cb66-84"><a href="pattern-rules.html#cb66-84"></a></span>
<span id="cb66-85"><a href="pattern-rules.html#cb66-85"></a><span class="ex">rule</span> clean_analysis:</span>
<span id="cb66-86"><a href="pattern-rules.html#cb66-86"></a>    <span class="ex">shell</span>:</span>
<span id="cb66-87"><a href="pattern-rules.html#cb66-87"></a>        <span class="st">&quot;rm -rf out/analysis/*&quot;</span></span></code></pre></div>
<p>This is good progress, but if we look at the <em>solow_</em> rules we see that there is quite a lot of duplication.
All rules three use the same script, data, and model inputs.
They only differ in the data subsetting found under <code>{input.subset}</code> and the output file define under <code>{output.estimate}</code>.</p>
<p>Ideally, we want <code>Snakefile</code> to feature the minimum amount of duplication possible.
This has a few advantages:</p>
<p>Limiting redundancy allows us to make changes to the code only once rather than multiple times (imagine changing the <code>{data.input}</code> file).
Any additional copy of code also introduces extra opportunities of typos or other errors and makes the build file generally harder to read and navigate.
And if we’re completely honest, it’s also a just a bit ugly…</p>
<p>In this chapter we will</p>
<p>A straight forward solution to remove redundancy is
The three <em>solow_</em> rules can be collapsed into one rule if can create a variable, for example <code>iSubset</code>,
that can iterate through the three .json files that contain the subset filters.
That is, we want to create a rule <code>solow_model</code> that can do the work that <code>solow_nonoil</code>, <code>solow_oecd</code> and <code>solow_intermediate</code> currently do.
In Snakemake, these variables are called <em>wildcards</em>.</p>
<p>The format of this rule will be:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb67-1"><a href="pattern-rules.html#cb67-1"></a><span class="ex">rule</span> solow_model:</span>
<span id="cb67-2"><a href="pattern-rules.html#cb67-2"></a>    <span class="ex">input</span>:</span>
<span id="cb67-3"><a href="pattern-rules.html#cb67-3"></a>        <span class="ex">script</span> = <span class="st">&quot;src/analysis/estimate_ols_model.R&quot;</span>,</span>
<span id="cb67-4"><a href="pattern-rules.html#cb67-4"></a>        <span class="ex">data</span>   = <span class="st">&quot;out/data/mrw_complete.csv&quot;</span>,</span>
<span id="cb67-5"><a href="pattern-rules.html#cb67-5"></a>        <span class="ex">model</span>  = <span class="st">&quot;src/model-specs/model_solow.json&quot;</span>,</span>
<span id="cb67-6"><a href="pattern-rules.html#cb67-6"></a>        <span class="ex">subset</span> = <span class="st">&quot;src/data-specs/subset_{iSubset}.json&quot;</span></span>
<span id="cb67-7"><a href="pattern-rules.html#cb67-7"></a>    <span class="ex">output</span>:</span>
<span id="cb67-8"><a href="pattern-rules.html#cb67-8"></a>        <span class="ex">model_est</span> = <span class="st">&quot;out/analysis/model_solow_{iSubset}.rds&quot;</span>,</span>
<span id="cb67-9"><a href="pattern-rules.html#cb67-9"></a>    <span class="ex">shell</span>:</span>
<span id="cb67-10"><a href="pattern-rules.html#cb67-10"></a>        <span class="st">&quot;Rscript {input.script} \</span></span>
<span id="cb67-11"><a href="pattern-rules.html#cb67-11"></a><span class="st">            --data {input.data} \</span></span>
<span id="cb67-12"><a href="pattern-rules.html#cb67-12"></a><span class="st">            --model {input.model} \</span></span>
<span id="cb67-13"><a href="pattern-rules.html#cb67-13"></a><span class="st">            --subset {input.subset} \</span></span>
<span id="cb67-14"><a href="pattern-rules.html#cb67-14"></a><span class="st">            --out {output.model_est}&quot;</span></span></code></pre></div>
<p>We wrapped our wildcard <code>iSubset</code> in curly parentheses so that Snakemake knows that we will want to substitute the name of one of the subsets into this value.
This is conceptually similar to what we have done in our shell commands.</p>
<p>We can now try and run our updated Snakefile:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb68-1"><a href="pattern-rules.html#cb68-1"></a>$ <span class="ex">snakemake</span></span></code></pre></div>
<pre class="out"><code>Building DAG of jobs...
WorkflowError:
Target rules may not contain wildcards. Please specify concrete files or a rule without wildcards.</code></pre>
<p>What has happened?
Snakemake will not execute a rule that contains wildcards.<a href="#fn8" class="footnote-ref" id="fnref8"><sup>8</sup></a>
What we will do is create another rule, <code>run_solow</code> that will not contain wildcards …</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb70-1"><a href="pattern-rules.html#cb70-1"></a></span>
<span id="cb70-2"><a href="pattern-rules.html#cb70-2"></a><span class="ex">rule</span> run_solow:</span>
<span id="cb70-3"><a href="pattern-rules.html#cb70-3"></a>    <span class="ex">input</span>:</span>
<span id="cb70-4"><a href="pattern-rules.html#cb70-4"></a>        <span class="ex">nonoil</span> = <span class="st">&quot;out/analysis/model_solow_nonoil.rds&quot;</span>,</span>
<span id="cb70-5"><a href="pattern-rules.html#cb70-5"></a>        <span class="ex">oecd</span>   = <span class="st">&quot;out/analysis/model_solow_oecd.rds&quot;</span>,</span>
<span id="cb70-6"><a href="pattern-rules.html#cb70-6"></a>        <span class="ex">intermediate</span> = <span class="st">&quot;out/analysis/model_solow_intermediate.rds&quot;</span></span>
<span id="cb70-7"><a href="pattern-rules.html#cb70-7"></a></span>
<span id="cb70-8"><a href="pattern-rules.html#cb70-8"></a><span class="ex">rule</span> solow_model:</span>
<span id="cb70-9"><a href="pattern-rules.html#cb70-9"></a>    <span class="ex">input</span>:</span>
<span id="cb70-10"><a href="pattern-rules.html#cb70-10"></a>        <span class="ex">script</span> = <span class="st">&quot;src/analysis/estimate_ols_model.R&quot;</span>,</span>
<span id="cb70-11"><a href="pattern-rules.html#cb70-11"></a>        <span class="ex">data</span>   = <span class="st">&quot;out/data/mrw_complete.csv&quot;</span>,</span>
<span id="cb70-12"><a href="pattern-rules.html#cb70-12"></a>        <span class="ex">model</span>  = <span class="st">&quot;src/model-specs/model_solow.json&quot;</span>,</span>
<span id="cb70-13"><a href="pattern-rules.html#cb70-13"></a>        <span class="ex">subset</span> = <span class="st">&quot;src/data-specs/subset_{iSubset}.json&quot;</span></span>
<span id="cb70-14"><a href="pattern-rules.html#cb70-14"></a>    <span class="ex">output</span>:</span>
<span id="cb70-15"><a href="pattern-rules.html#cb70-15"></a>        <span class="ex">model_est</span> = <span class="st">&quot;out/analysis/model_solow_{iSubset}.rds&quot;</span>,</span>
<span id="cb70-16"><a href="pattern-rules.html#cb70-16"></a>    <span class="ex">shell</span>:</span>
<span id="cb70-17"><a href="pattern-rules.html#cb70-17"></a>        <span class="st">&quot;Rscript {input.script} \</span></span>
<span id="cb70-18"><a href="pattern-rules.html#cb70-18"></a><span class="st">            --data {input.data} \</span></span>
<span id="cb70-19"><a href="pattern-rules.html#cb70-19"></a><span class="st">            --model {input.model} \</span></span>
<span id="cb70-20"><a href="pattern-rules.html#cb70-20"></a><span class="st">            --subset {input.subset} \</span></span>
<span id="cb70-21"><a href="pattern-rules.html#cb70-21"></a><span class="st">            --out {output.model_est}&quot;</span></span></code></pre></div>
<p>Explain what happens here…</p>
<p>There’s more work we can do to reduce duplication.
Look at the rule <code>run_solow</code>:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb71-1"><a href="pattern-rules.html#cb71-1"></a><span class="ex">rule</span> run_solow:</span>
<span id="cb71-2"><a href="pattern-rules.html#cb71-2"></a>    <span class="ex">input</span>:</span>
<span id="cb71-3"><a href="pattern-rules.html#cb71-3"></a>        <span class="ex">nonoil</span> = <span class="st">&quot;out/analysis/model_solow_nonoil.rds&quot;</span>,</span>
<span id="cb71-4"><a href="pattern-rules.html#cb71-4"></a>        <span class="ex">oecd</span>   = <span class="st">&quot;out/analysis/model_solow_oecd.rds&quot;</span>,</span>
<span id="cb71-5"><a href="pattern-rules.html#cb71-5"></a>        <span class="ex">intermediate</span> = <span class="st">&quot;out/analysis/model_solow_intermediate.rds&quot;</span></span></code></pre></div>
</div>
<div id="the-expand-function" class="section level2">
<h2><span class="header-section-number">5.3</span> The <code>expand()</code> function</h2>
<p>Each of these inputs listed above have similar structure, with only the name of the subset of data we are using changing.
We can use another feature of Snakemake to simplify this rule.
Snakemake has an <code>expand()</code> function that can accept a wildcard and replace it with a set of specified values in an iterative manner.
In our case, we want to use the expand function to accept the <code>{iSubset}</code> wildcard, and replace it with the values ‘nonoil’, ‘oecd’ and ‘intermediate’ one at a time.
To proceed we need to do two things:</p>
<ol style="list-style-type: decimal">
<li>Create a list, DATA_SUBSETS, that contains the values we want to iterate through - ‘nonoil’, ‘oecd’ and ‘intermediate’.</li>
<li>Use Snakemake’s <code>expand()</code> function to iteratively replace <code>{iSubset}</code> with each value contained in the list <code>DATA_SUBSET</code></li>
</ol>
<p>Let’s start with (1).
We will use an area above our Snakemake rules to store the <code>DATA_SUBSET</code> variable:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb72-1"><a href="pattern-rules.html#cb72-1"></a><span class="ex">DATA_SUBSET</span> = [</span>
<span id="cb72-2"><a href="pattern-rules.html#cb72-2"></a>                <span class="st">&quot;oecd&quot;</span>,</span>
<span id="cb72-3"><a href="pattern-rules.html#cb72-3"></a>                <span class="st">&quot;intermediate&quot;</span>,</span>
<span id="cb72-4"><a href="pattern-rules.html#cb72-4"></a>                <span class="st">&quot;nonoil&quot;</span></span>
<span id="cb72-5"><a href="pattern-rules.html#cb72-5"></a>                ]</span>
<span id="cb72-6"><a href="pattern-rules.html#cb72-6"></a></span>
<span id="cb72-7"><a href="pattern-rules.html#cb72-7"></a><span class="co"># --- Build Rules --- #</span></span>
<span id="cb72-8"><a href="pattern-rules.html#cb72-8"></a><span class="ex">...</span></span></code></pre></div>
<p>The capitalization of the list DATA_SUBSET is not essential.
We do it to separate lists that we will iterate through from other parts of our Snakefile.
This means whenever we see a capitalized name, we know it is a list that we want to iterate through.</p>
<p>Next, we update the rule <code>run_solow</code> as follows:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb73-1"><a href="pattern-rules.html#cb73-1"></a><span class="ex">rule</span> run_solow:</span>
<span id="cb73-2"><a href="pattern-rules.html#cb73-2"></a>    <span class="ex">input</span>:</span>
<span id="cb73-3"><a href="pattern-rules.html#cb73-3"></a>        <span class="ex">expand</span>(<span class="st">&quot;out/analysis/model_solow_{iSubset}.rds&quot;</span>,</span>
<span id="cb73-4"><a href="pattern-rules.html#cb73-4"></a>                    <span class="ex">iSubset</span> = DATA_SUBSET)</span></code></pre></div>
<p>Now, we can clean our output folder with <code>$ snakemake clean</code>.
If we re-run snakemake we would expect everything to run.
To see if this is the case we can do a <em>dry run</em>.
A dry run will try go through the Snakefile and print all the rules Snakemake wants to execute in order.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb74-1"><a href="pattern-rules.html#cb74-1"></a>$ <span class="ex">snakemake</span> --dryrun</span></code></pre></div>
<p>which yields the following plan:</p>
<pre class="out"><code>Building DAG of jobs...
Job counts:
    count   jobs
    1   gen_regression_vars
    1   rename_vars
    1   run_solow
    3   solow_model
    6

[Fri Jan 11 17:00:32 2019]
rule rename_vars:
    input: src/data/mrw.dta, src/data-management/rename_variables.R
    output: out/data/mrw_renamed.csv
    jobid: 5


[Fri Jan 11 17:00:32 2019]
rule gen_regression_vars:
    input: out/data/mrw_renamed.csv, src/data-management/gen_reg_vars.R, src/data-specs/param_solow.json
    output: out/data/mrw_complete.csv
    jobid: 4


[Fri Jan 11 17:00:32 2019]
rule solow_model:
    input: src/data-specs/subset_nonoil.json, out/data/mrw_complete.csv, src/model-specs/model_solow.json, src/analysis/estimate_ols_model.R
    output: out/analysis/model_solow_nonoil.rds
    jobid: 1
    wildcards: iSubset=nonoil


[Fri Jan 11 17:00:32 2019]
rule solow_model:
    input: src/data-specs/subset_oecd.json, out/data/mrw_complete.csv, src/model-specs/model_solow.json, src/analysis/estimate_ols_model.R
    output: out/analysis/model_solow_oecd.rds
    jobid: 2
    wildcards: iSubset=oecd


[Fri Jan 11 17:00:32 2019]
rule solow_model:
    input: src/data-specs/subset_intermediate.json, out/data/mrw_complete.csv, src/model-specs/model_solow.json, src/analysis/estimate_ols_model.R
    output: out/analysis/model_solow_intermediate.rds
    jobid: 3
    wildcards: iSubset=intermediate


[Fri Jan 11 17:00:32 2019]
localrule run_solow:
    input: out/analysis/model_solow_nonoil.rds, out/analysis/model_solow_oecd.rds, out/analysis/model_solow_intermediate.rds
    jobid: 0

Job counts:
    count   jobs
    1   gen_regression_vars
    1   rename_vars
    1   run_solow
    3   solow_model
    6
</code></pre>
<p>This looks like what we want to happen.
Hence, we re-run snakemake to produce all output:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb76-1"><a href="pattern-rules.html#cb76-1"></a>$ <span class="ex">snakemake</span></span></code></pre></div>
<div id="exercise-exploring-the-expand-function-i" class="section level3 unnumbered exercise">
<h3>Exercise: Exploring the expand() function I</h3>
<p>So far we have estimated the basic Solow model.
MRW also estimate an augmented version of the Solow model, adding human capital.
The formula required to estimate the augmented model is written up in <code>src/model-specs/model_aug_solow.json</code>.
Use the <code>expand()</code> function together with the <code>estimate_ols.R</code> script to estimate the augmented solow model on each of the three data subsets.
The rule structures should look very similar to what we have done so far.</p>
</div>
<div id="exercise-exploring-the-expand-function-ii" class="section level3 unnumbered exercise">
<h3>Exercise: Exploring the expand function II</h3>
<p>The MRW paper contains three plots.
Each of these plots use the subset of ‘intermediate’ countries.
In the <code>src/figures/</code> subdirectory, there are three scripts that reproduce each of the figures.<a href="#fn9" class="footnote-ref" id="fnref9"><sup>9</sup></a>
The scripts are written in such a way that they accept exactly the same options.
Using wildcards and the expand function extend the Snakefile to construct each figure.
Each figure should be saved with the following name ‘out/figures/SCRIPTNAME.pdf’</p>
</div>
</div>
<div id="expanding-multiple-wildcards" class="section level2">
<h2><span class="header-section-number">5.4</span> Expanding Multiple Wildcards</h2>
<p>The rules used to estimate the standard Solow model, and the augmented Solow model have very similar structure:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb77-1"><a href="pattern-rules.html#cb77-1"></a><span class="ex">DATA_SUBSET</span> = [</span>
<span id="cb77-2"><a href="pattern-rules.html#cb77-2"></a>                <span class="st">&quot;oecd&quot;</span>,</span>
<span id="cb77-3"><a href="pattern-rules.html#cb77-3"></a>                <span class="st">&quot;intermediate&quot;</span>,</span>
<span id="cb77-4"><a href="pattern-rules.html#cb77-4"></a>                <span class="st">&quot;nonoil&quot;</span></span>
<span id="cb77-5"><a href="pattern-rules.html#cb77-5"></a>                ]</span>
<span id="cb77-6"><a href="pattern-rules.html#cb77-6"></a></span>
<span id="cb77-7"><a href="pattern-rules.html#cb77-7"></a><span class="co"># --- Build Rules --- #</span></span>
<span id="cb77-8"><a href="pattern-rules.html#cb77-8"></a><span class="ex">rule</span> run_aug_solow:</span>
<span id="cb77-9"><a href="pattern-rules.html#cb77-9"></a>    <span class="ex">input</span>:</span>
<span id="cb77-10"><a href="pattern-rules.html#cb77-10"></a>        <span class="ex">expand</span>(<span class="st">&quot;out/analysis/model_aug_solow_{iSubset}.rds&quot;</span>,</span>
<span id="cb77-11"><a href="pattern-rules.html#cb77-11"></a>                    <span class="ex">iSubset</span> = DATA_SUBSET)</span>
<span id="cb77-12"><a href="pattern-rules.html#cb77-12"></a></span>
<span id="cb77-13"><a href="pattern-rules.html#cb77-13"></a><span class="ex">rule</span> aug_solow_model:</span>
<span id="cb77-14"><a href="pattern-rules.html#cb77-14"></a>    <span class="ex">input</span>:</span>
<span id="cb77-15"><a href="pattern-rules.html#cb77-15"></a>        <span class="ex">script</span> = <span class="st">&quot;src/analysis/estimate_ols_model.R&quot;</span>,</span>
<span id="cb77-16"><a href="pattern-rules.html#cb77-16"></a>        <span class="ex">data</span>   = <span class="st">&quot;out/data/mrw_complete.csv&quot;</span>,</span>
<span id="cb77-17"><a href="pattern-rules.html#cb77-17"></a>        <span class="ex">model</span>  = <span class="st">&quot;src/model-specs/model_aug_solow.json&quot;</span>,</span>
<span id="cb77-18"><a href="pattern-rules.html#cb77-18"></a>        <span class="ex">subset</span> = <span class="st">&quot;src/data-specs/subset_{iSubset}.json&quot;</span></span>
<span id="cb77-19"><a href="pattern-rules.html#cb77-19"></a>    <span class="ex">output</span>:</span>
<span id="cb77-20"><a href="pattern-rules.html#cb77-20"></a>        <span class="ex">model_est</span> = <span class="st">&quot;out/analysis/model_aug_solow_{iSubset}.rds&quot;</span>,</span>
<span id="cb77-21"><a href="pattern-rules.html#cb77-21"></a>    <span class="ex">shell</span>:</span>
<span id="cb77-22"><a href="pattern-rules.html#cb77-22"></a>        <span class="st">&quot;Rscript {input.script} \</span></span>
<span id="cb77-23"><a href="pattern-rules.html#cb77-23"></a><span class="st">            --data {input.data} \</span></span>
<span id="cb77-24"><a href="pattern-rules.html#cb77-24"></a><span class="st">            --model {input.model} \</span></span>
<span id="cb77-25"><a href="pattern-rules.html#cb77-25"></a><span class="st">            --subset {input.subset} \</span></span>
<span id="cb77-26"><a href="pattern-rules.html#cb77-26"></a><span class="st">            --out {output.model_est}&quot;</span></span>
<span id="cb77-27"><a href="pattern-rules.html#cb77-27"></a></span>
<span id="cb77-28"><a href="pattern-rules.html#cb77-28"></a><span class="ex">rule</span> run_solow:</span>
<span id="cb77-29"><a href="pattern-rules.html#cb77-29"></a>    <span class="ex">input</span>:</span>
<span id="cb77-30"><a href="pattern-rules.html#cb77-30"></a>        <span class="ex">expand</span>(<span class="st">&quot;out/analysis/model_solow_{iSubset}.rds&quot;</span>,</span>
<span id="cb77-31"><a href="pattern-rules.html#cb77-31"></a>                    <span class="ex">iSubset</span> = DATA_SUBSET)</span>
<span id="cb77-32"><a href="pattern-rules.html#cb77-32"></a></span>
<span id="cb77-33"><a href="pattern-rules.html#cb77-33"></a><span class="ex">rule</span> solow_model:</span>
<span id="cb77-34"><a href="pattern-rules.html#cb77-34"></a>    <span class="ex">input</span>:</span>
<span id="cb77-35"><a href="pattern-rules.html#cb77-35"></a>        <span class="ex">script</span> = <span class="st">&quot;src/analysis/estimate_ols_model.R&quot;</span>,</span>
<span id="cb77-36"><a href="pattern-rules.html#cb77-36"></a>        <span class="ex">data</span>   = <span class="st">&quot;out/data/mrw_complete.csv&quot;</span>,</span>
<span id="cb77-37"><a href="pattern-rules.html#cb77-37"></a>        <span class="ex">model</span>  = <span class="st">&quot;src/model-specs/model_solow.json&quot;</span>,</span>
<span id="cb77-38"><a href="pattern-rules.html#cb77-38"></a>        <span class="ex">subset</span> = <span class="st">&quot;src/data-specs/subset_{iSubset}.json&quot;</span></span>
<span id="cb77-39"><a href="pattern-rules.html#cb77-39"></a>    <span class="ex">output</span>:</span>
<span id="cb77-40"><a href="pattern-rules.html#cb77-40"></a>        <span class="ex">model_est</span> = <span class="st">&quot;out/analysis/model_solow_{iSubset}.rds&quot;</span>,</span>
<span id="cb77-41"><a href="pattern-rules.html#cb77-41"></a>    <span class="ex">shell</span>:</span>
<span id="cb77-42"><a href="pattern-rules.html#cb77-42"></a>        <span class="st">&quot;Rscript {input.script} \</span></span>
<span id="cb77-43"><a href="pattern-rules.html#cb77-43"></a><span class="st">            --data {input.data} \</span></span>
<span id="cb77-44"><a href="pattern-rules.html#cb77-44"></a><span class="st">            --model {input.model} \</span></span>
<span id="cb77-45"><a href="pattern-rules.html#cb77-45"></a><span class="st">            --subset {input.subset} \</span></span>
<span id="cb77-46"><a href="pattern-rules.html#cb77-46"></a><span class="st">            --out {output.model_est}&quot;</span></span></code></pre></div>
<p>Add text …</p>
<p>Ultimately the Snakfile becomes:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb78-1"><a href="pattern-rules.html#cb78-1"></a><span class="ex">MODELS</span> = [</span>
<span id="cb78-2"><a href="pattern-rules.html#cb78-2"></a>          <span class="st">&quot;solow&quot;</span>,</span>
<span id="cb78-3"><a href="pattern-rules.html#cb78-3"></a>          <span class="st">&quot;aug_solow&quot;</span></span>
<span id="cb78-4"><a href="pattern-rules.html#cb78-4"></a>          ]</span>
<span id="cb78-5"><a href="pattern-rules.html#cb78-5"></a></span>
<span id="cb78-6"><a href="pattern-rules.html#cb78-6"></a><span class="ex">DATA_SUBSET</span> = [</span>
<span id="cb78-7"><a href="pattern-rules.html#cb78-7"></a>                <span class="st">&quot;oecd&quot;</span>,</span>
<span id="cb78-8"><a href="pattern-rules.html#cb78-8"></a>                <span class="st">&quot;intermediate&quot;</span>,</span>
<span id="cb78-9"><a href="pattern-rules.html#cb78-9"></a>                <span class="st">&quot;nonoil&quot;</span></span>
<span id="cb78-10"><a href="pattern-rules.html#cb78-10"></a>                ]</span>
<span id="cb78-11"><a href="pattern-rules.html#cb78-11"></a></span>
<span id="cb78-12"><a href="pattern-rules.html#cb78-12"></a><span class="co"># --- Build Rules --- #</span></span>
<span id="cb78-13"><a href="pattern-rules.html#cb78-13"></a></span>
<span id="cb78-14"><a href="pattern-rules.html#cb78-14"></a><span class="ex">rule</span> estimate_models:</span>
<span id="cb78-15"><a href="pattern-rules.html#cb78-15"></a>    <span class="ex">input</span>:</span>
<span id="cb78-16"><a href="pattern-rules.html#cb78-16"></a>        <span class="ex">expand</span>(<span class="st">&quot;out/analysis/{iModel}_{iSubset}.rds&quot;</span>,</span>
<span id="cb78-17"><a href="pattern-rules.html#cb78-17"></a>                    <span class="ex">iModel</span> = MODELS,</span>
<span id="cb78-18"><a href="pattern-rules.html#cb78-18"></a>                    <span class="ex">iSubset</span> = DATA_SUBSET)</span>
<span id="cb78-19"><a href="pattern-rules.html#cb78-19"></a></span>
<span id="cb78-20"><a href="pattern-rules.html#cb78-20"></a><span class="ex">rule</span> ols_model:</span>
<span id="cb78-21"><a href="pattern-rules.html#cb78-21"></a>    <span class="ex">input</span>:</span>
<span id="cb78-22"><a href="pattern-rules.html#cb78-22"></a>        <span class="ex">script</span> = <span class="st">&quot;src/analysis/estimate_ols_model.R&quot;</span>,</span>
<span id="cb78-23"><a href="pattern-rules.html#cb78-23"></a>        <span class="ex">data</span>   = <span class="st">&quot;out/data/mrw_complete.csv&quot;</span>,</span>
<span id="cb78-24"><a href="pattern-rules.html#cb78-24"></a>        <span class="ex">model</span>  = <span class="st">&quot;src/model-specs/model_{iModel}.json&quot;</span>,</span>
<span id="cb78-25"><a href="pattern-rules.html#cb78-25"></a>        <span class="ex">subset</span> = <span class="st">&quot;src/data-specs/subset_{iSubset}.json&quot;</span></span>
<span id="cb78-26"><a href="pattern-rules.html#cb78-26"></a>    <span class="ex">output</span>:</span>
<span id="cb78-27"><a href="pattern-rules.html#cb78-27"></a>        <span class="ex">model_est</span> = <span class="st">&quot;out/analysis/model_{iModel}_{iSubset}.rds&quot;</span>,</span>
<span id="cb78-28"><a href="pattern-rules.html#cb78-28"></a>    <span class="ex">shell</span>:</span>
<span id="cb78-29"><a href="pattern-rules.html#cb78-29"></a>        <span class="st">&quot;Rscript {input.script} \</span></span>
<span id="cb78-30"><a href="pattern-rules.html#cb78-30"></a><span class="st">            --data {input.data} \</span></span>
<span id="cb78-31"><a href="pattern-rules.html#cb78-31"></a><span class="st">            --model {input.model} \</span></span>
<span id="cb78-32"><a href="pattern-rules.html#cb78-32"></a><span class="st">            --subset {input.subset} \</span></span>
<span id="cb78-33"><a href="pattern-rules.html#cb78-33"></a><span class="st">            --out {output.model_est}&quot;</span></span>
<span id="cb78-34"><a href="pattern-rules.html#cb78-34"></a></span>
<span id="cb78-35"><a href="pattern-rules.html#cb78-35"></a><span class="op">&lt;</span><span class="ex">...</span><span class="op">&gt;</span> <span class="co">## Other Rules below</span></span></code></pre></div>

</div>
</div>
<div class="footnotes">
<hr />
<ol start="8">
<li id="fn8"><p>
Technically there is another problem here too.
Snakemake doesn’t know what values to substitute into <code>iSubset.</code>
We focus on the Wildcard error because this is what the Snakemake error message mentions.
By fixing this error, it turns out we also spell out what values to substitute into <code>iSubset</code>.<a href="pattern-rules.html#fnref8" class="footnote-back">↩︎</a></p></li>
<li id="fn9"><p>
This is not entirely true, we are yet to figure out how to get the y-axis range from the original paper.<a href="pattern-rules.html#fnref9" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="working-with-multiple-rules.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="automatic-wildcard-specifications.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/05-pattern_rules.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["book.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
