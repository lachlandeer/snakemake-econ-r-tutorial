[
["index.html", "Reproducible Research Workflows with Snakemake and R Prerequisites", " Reproducible Research Workflows with Snakemake and R An Extended Tutorial for Economists and Social Scientists Lachlan Deer Julian Langer 2019-01-11 Prerequisites This is a sample book written in Markdown. You can use anything that Pandoc’s Markdown supports, e.g., a math equation \\(a^2 + b^2 = c^2\\). The bookdown package can be installed from CRAN or Github: "],
["intro.html", "Chapter 1 Motivating &amp; Rationale 1.1 A Case for Reproducibility 1.2 What is Snakemake &amp; Why Should you use it? 1.3 Why R? 1.4 Working Example: Replicating Mankiw, Romer and Weil’s 1992 QJE 1.5 The way forward", " Chapter 1 Motivating &amp; Rationale 1.1 A Case for Reproducibility 1.1.1 How far to go in the quest for reproducibility? 1.2 What is Snakemake &amp; Why Should you use it? 1.3 Why R? 1.4 Working Example: Replicating Mankiw, Romer and Weil’s 1992 QJE Throughout our tutorial we are going to use a running example to illustrate the concepts we discuss. 1.5 The way forward For the purpose of this tutorial we will focus on replicating the following aspects of the MRW paper:1 Regression Tables 1 and 2: Estimating the Textbook- and Augmented Solow Model Figure 1: Unconditional Versus Conditional Convergence To replicate these we will need to proceed as follows: Perform some data management Prepare the data before we run regressions Do some analysis. For example, run regressions for: Different subsets of data Alternative econometric specifications Turn the statistical output of the regressions into a tabular format that we can insert into a document Construct a set of graphs Integrate the tables and graphs into a paper and a set of slides (optional) We hope that these 5 steps look familiar - as they were designed to represent a simplifed workflow for an applied economist or social science researcher. Before proceeding to understanding how to use Snakemake and R to construct a reproducible workflow, the next chapter first takes a deeper dive into the a protypical way to set up a research project on our computer. Exercise: Your own project’s steps Think about a project you are working on or have worked on in the past (it may be a Bachelor or Master’s thesis or a recent / active research project). Does your project fit into the 5 steps we described above? If not, what would you modify or add to our 5 steps? (Do you think this would destroy the general principles we will encourage over the next chapters?) A complete replication using the concepts presented in this tutorial is available here↩ "],
["part-i.html", "PART I", " PART I "],
["project-organization.html", "Chapter 2 Project Organization 2.1 Project Structure I: Separating Inputs and Outputs 2.2 Project Structure II: Separating Logical Chunks of the Project 2.3 Project Structure III: Separating Input Parameters from Code", " Chapter 2 Project Organization 2.1 Project Structure I: Separating Inputs and Outputs Structuring our project and the locations of files is an important concept. Let’s look at the structure of our project’s folder. Open a terminal and change into this directory cd YOUR/PATH/TO/snakemake-econ-r-student And list the subdirectories of the main directory ls -d */ We see the following folder structure ./ |- src/ |- out/ |- log/ |- sandbox/ We recommend the following structure for any project: Root Folder src folder for input files out folder for output files a log folder to store computer logs a sandbox folder that gives us a ‘safe place’ to develop new code We discuss each of these in turn. 2.1.1 The Root Folder TBD 2.1.2 The src folder TBD 2.1.3 The out folder TBD 2.1.4 The log folder 2.1.5 Exploring the Full Structure of the MRW Replication Project Now, let’s look at all contents of this main projects directory: ls -F . We see the following folder structure ./ |- src/ |- out/ |- log/ |- sandbox/ | README.md | Snakefile Notice that there are no instances of: (i) scripts, (ii) files containing content of the paper or slides (iii) something else we haven’t thought of yet Instead, there are only two files, a README.md and a file called Snakefile. TODO: explain these two files 2.2 Project Structure II: Separating Logical Chunks of the Project As we have mentioned above, to keep our project’s structure clean, we want to keep all the computer code inside the src directory. Let’s have a look at the content of src. ls -F src/ We see the following output: ./ |src/ |- data/ |- data-management/ |- data-specs/ |- analysis/ |- model-specs/ |- lib/ |- figures/ |- tables/ The type of content we expect in each file is: TBD 2.2.1 Exploring the Structure of the MRW Replication Subdirectories We begin our exploration of the project by looking at the folders that appear to be related to the data. If we look inside the data directory ls -F src/data/ mrw.dta That is, our data/ directory contains the project’s original data set. Note that in more extensive projects, the data/ subfolder would typically have more than one data set. For example: dataset1.dta dataset2.dta dataset3.csv TBD - aside on file endings. Further, your data folder may even contain further subdirectories that organize data further ./ |src/ |- data/ |- data-provider-a/ |- dataset1.csv |- dataset2.csv |- data-provider-b/ |- dataset3.txt |- dataset4.txt If we now turn to the data-management directory, we can explore it’s contents too: ls -F src/data-management/ rename_variables.R gen_reg_vars.R TODO: meaningful filenames Note two different ways to name files Exercise: Exploring the Remaining Subdirectories TBD 2.3 Project Structure III: Separating Input Parameters from Code Next we look at the somewhat mysteriously named data-specs folder. And if we explore the folder’s contents: ls -F src/data-specs/ subset_intermediate.json subset_nonoil.json subset_oecd.json Again, the file names are somewhat meaningful on their own - they appear to be some way of subsetting data (selecting some rows). If we look inside one of these files: cat src/data-specs/subset_oecd.json { &quot;KEEP_CONDITION&quot;: &quot;oecd == 1&quot; } We see an a variable KEEP_CONDITION which is storing a string &quot;oecd == 1&quot;. TBD: Why have we done this? See below. 2.3.1 Exploring Parameter Separation in the MRW Replication Project "],
["initial-steps-with-snakemake.html", "Chapter 3 Initial Steps with Snakemake 3.1 Starting a Research Project 3.2 The Beginning of a Snakefile 3.3 Rule Structure 3.4 Our First Rule 3.5 Creating a Second Rule", " Chapter 3 Initial Steps with Snakemake 3.1 Starting a Research Project We are now ready to get started working with the code and data to build a fully reproducible pipeline. In Chapter XX we described a simplified research workflow to be: Perform some data management Do some analysis Turn the output of the analysis into a tabular format Construct a set of graphs Integrate the tables and graphs into a paper and a set of slides (optional) We are going to start at the beginning with data management. Recall that we have the following files in our data management subdirectory, src/data-management: rename_variables.R gen_reg_vars.R We will need to run each of these scripts sequentially. First we want to run the script rename_variables.R to tidy up the variable names in our data set. Second, gen_reg_vars.R will create the some additional variables in our data that will be needed to run some regressions in later steps. Over the next few sections we are going to build up 2 rules, one for each file, that will execute these scripts and deliver output. 3.2 The Beginning of a Snakefile We are going to put the collection of rules that build our project into a file. We can then use the Snakemake to execute these rules and build our project. The set of rules we want to construct are going to go into the file called Snakefile - which is the name of a file that Snakemake will look into by default to execite a project. Lets open the file called Snakefile in the project’s main directory. When you open it it should look as follows: # Main Workflow - SOME PROJECT # # Contributors: YOUR NAME(S) Note that the amount of structure we have here is not totally necessary. However, good structure will make understanding easier later. Let’s go through what we see. The first lines of code are comments, to help us navigate a little and understand what we are looking at. The very first line tells us that this is a project workflow, and then tells us what the particular project is. The second line tells us who contributed to this file. This can be useful so we know who to contact with questions. You should do update the name of the project, and add your name to the list of contributors. For us, the top 2 lines becomes: # Main Workflow - MRW Replication # # Contributors: @lachlandeer, @julianlanger The next few lines are: # --- Main Build Rules --- # ## To be constructed These are more comments. We are using the # --- Something --- # notation to break up the code into logical blocks. It is in this block that we will assemble the rules on which our project will be built. 3.3 Rule Structure A Snakefile is a collection of rules that together define the order in which a project will be executed. In our Snakefile we will start to assemble rules under the # --- Main Build Rules --- # section to keep things tidy. Each rule can be thought of as a recipe that combines different inputs, such as data and and R script together to produce one or more output(s). The key components we are going to use to construct a rule are: a name for the rule, the list of inputs the list of outputs produced a shell command that tells snakemake how to combine the inputs to produce a outputs. Snakemake expects these components to be provided in a particular way so that it knows what to do with the information you provided. We are going to specify rules in the following format: rule rule_name: input: input_name1 = &quot;PATH/TO/input_one&quot;, input_name2 = &quot;PATH/TO/input_two&quot; output: output_name1 = &quot;PATH/TO/SAVE/output_one&quot;, output_name2 = &quot;PATH/TO/SAVE/output_two&quot; shell: &quot;HOW TO MIX IT ALL TOGETHER&quot; We can have as many inputs and outputs as we need to have per rule. Each input and each output are given names, for example input_name1 which take the value to the file path and name of the file. It is important to wrap each of these paths into quotations, and to separate each of the multiple inputs and outputs with a comma. 3.4 Our First Rule 3.4.1 Constructing the Rule As mentioned above, we will start with the data management step. First script to run is rename_variables.R which is located in the data management subdirectory. This is a simple script that renames some variables for us to be easier to understand. We can then start our snakemake script by adding this script as an input: rule rule_name: input: script = &quot;src/data-management/rename_variables.R&quot;, input_name2 = &quot;PATH/TO/input_two&quot; output: output_name1 = &quot;PATH/TO/SAVE/output_one&quot;, output_name2 = &quot;PATH/TO/SAVE/output_two&quot; shell: &quot;HOW TO MIX IT ALL TOGETHER&quot; Next, we want to add any additional inputs and also specify any outputs that the file produces. We have set up all R scripts in this example to provide us with ‘help’ so that we know what we might need to add. To find out what inputs are required and what outputs are produced, we use the --help flag when calling the file with R: $ Rscript src/data-management/rename_variables.R --help And the following output is produced: Usage: src/data-management/rename_variables.R [options] Options: -d CHARACTER, --data=CHARACTER stata dataset file name -o CHARACTER, --out=CHARACTER output file name [default = out.csv] -h, --help Show this help message and exit This suggests the script needs … We update our rename_variables as: rule rename_vars: input: script = &quot;src/data-management/rename_variables.R&quot;, data = &quot;src/data/mrw.dta&quot; output: data = &quot;out/data/mrw_renamed.csv&quot; shell: &quot;HOW TO MIX IT ALL TOGETHER&quot; Next we provide a recipe telling snakemake how to mix the inputs to create the outputs: rule rename_vars: input: script = &quot;src/data-management/rename_variables.R&quot;, data = &quot;src/data/mrw.dta&quot; output: data = &quot;out/data/mrw_renamed.csv&quot; shell: &quot;Rscript {input.script} \\ --data {input.data} \\ --out {output.data}&quot; We can now try and run snakemake to execute this rule … $ snakemake Stuff happens … 3.4.2 Analysing Output We can look into our output directory to see if anything has happened: $ ls out/data/ which yields mrw_renamed.csv Our file has been created as we expected. Try and run snakemake again $ snakemake and we see the following output: Building DAG of jobs... Nothing to be done. Why? Snakemake provides the a summary option which tells us what is going on: snakemake --summary The output is: Building DAG of jobs... output_file date rule version log-file(s) status plan out/data/mrw_renamed.csv Thu Jan 10 20:31:08 2019 rename_vars - ok no update Explain what this tells us … Suppose we updated one of the inputs … $ touch src/data-management/rename_variables.R and then look at the summary from snakemake: $ snakemake Building DAG of jobs... output_file date rule version log-file(s) status plan out/data/mrw_renamed.csv Thu Jan 10 20:31:08 2019 rename_vars - updated input files update pending What this means? Run snakemake to build the output: snakemake Exercise: Deleting Output Delete the output out/data/mrw_renamed.csv. Run snakemake --summary and explain the output it produced. 3.5 Creating a Second Rule The second step in our data management is to create some variables we will use in our regression analysis. The script gen_reg_vars.R in the src/data-management folder does this for us. We are going to build a rule called gen_regression_vars to do this in Snakemake. Let’s see what the script expects to be passed: $ Rscript src/data-management/gen_reg_vars.R --help Usage: src/data-management/gen_reg_vars.R [options] Options: -d CHARACTER, --data=CHARACTER a csv file name -p CHARACTER, --param=CHARACTER a file name containing model parameters -o CHARACTER, --out=CHARACTER output file name [default = out.csv] -h, --help Show this help message and exit So we need to provide: to provide the output … Let’s create this rule: rule gen_regression_vars: input: script = &quot;src/data-management/gen_reg_vars.R&quot;, data = &quot;out/data/mrw_renamed.csv&quot;, params = &quot;src/data-specs/param_solow.json&quot;, output: data = &quot;out/data/mrw_complete.csv&quot; shell: &quot;Rscript {input.script} \\ --data {input.data} \\ --param {input.params} \\ --out {output.data}&quot; What will Snakemake want to do next? Let’s use the summary option to see … $ snakemake --summary Building DAG of jobs... output_file date rule version log-file(s) status plan out/data/mrw_complete.csv - gen_regression_vars - missing update pending out/data/mrw_renamed.csv Fri Jan 11 13:40:07 2019 rename_vars - ok no update Explain what this means Let’s run snakemake to build our new file: $ snakemake When we look at our output directory: $ ls out/data/ mrw_complete.csv mrw_renamed.csv So we see that our data set has been built. Exercise: Creating Rules The MRW paper estimates the Solow model for three subsets of data. You need to create rules to do estimate the Solow model for each of these data sets. The R script src/analysis/estimate_ols.R will estimate a OLS model for a given dataset when you provide the necessary inputs. What inputs do you need to provide? What outputs will be produced? Write Snakemake rules to estimate the solow model for each subset of data. "],
["pattern-rules.html", "Chapter 4 Pattern Rules", " Chapter 4 Pattern Rules Content is TBD "],
["wildcards.html", "Chapter 5 Wildcards", " Chapter 5 Wildcards Content is TBD "],
["adding-parameters.html", "Chapter 6 Adding Parameters", " Chapter 6 Adding Parameters Content is TBD "],
["an-all-rule.html", "Chapter 7 An all Rule", " Chapter 7 An all Rule Content is TBD "],
["logging-output-and-errors.html", "Chapter 8 Logging Output and Errors", " Chapter 8 Logging Output and Errors Content is TBD "],
["self-documenting-help.html", "Chapter 9 Self Documenting Help", " Chapter 9 Self Documenting Help Content is TBD "],
["config-files.html", "Chapter 10 Config Files", " Chapter 10 Config Files Content is TBD "],
["subworkflows-divide-and-conquer.html", "Chapter 11 Subworkflows: Divide and Conquer", " Chapter 11 Subworkflows: Divide and Conquer Content is TBD "],
["part-ii.html", "PART II", " PART II "],
["reproducible-articles-with-rmd.html", "Chapter 12 Reproducible Articles with Rmd", " Chapter 12 Reproducible Articles with Rmd Content is TBD "],
["reproducible-slides-with-rmd.html", "Chapter 13 Reproducible Slides with Rmd", " Chapter 13 Reproducible Slides with Rmd Content TBD "],
["package-dependencies-with-packrat.html", "Chapter 14 Package Dependencies with Packrat", " Chapter 14 Package Dependencies with Packrat "],
["containers.html", "Chapter 15 Containers", " Chapter 15 Containers "]
]
