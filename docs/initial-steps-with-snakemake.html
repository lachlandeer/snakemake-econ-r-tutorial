<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Reproducible Research Workflows with Snakemake and R</title>
  <meta name="description" content="In progress">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Reproducible Research Workflows with Snakemake and R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="In progress" />
  <meta name="github-repo" content="lachlandeer/snakemake-econ-r-tutorial" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Reproducible Research Workflows with Snakemake and R" />
  
  <meta name="twitter:description" content="In progress" />
  

<meta name="author" content="Lachlan Deer">
<meta name="author" content="Julian Langer">


<meta name="date" content="2019-02-04">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="project-organization.html">
<link rel="next" href="pattern-rules.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Reproducible Research Workflows with Snakemake and `R`</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Motivating &amp; Rationale</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#a-case-for-reproducibility"><i class="fa fa-check"></i><b>1.1</b> A Case for Reproducibility</a><ul>
<li class="chapter" data-level="1.1.1" data-path="intro.html"><a href="intro.html#how-far-to-go-in-the-quest-for-reproducibility"><i class="fa fa-check"></i><b>1.1.1</b> How far to go in the quest for reproducibility?</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#what-is-snakemake-why-should-you-use-it"><i class="fa fa-check"></i><b>1.2</b> What is <code>Snakemake</code> &amp; Why Should you use it?</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#why-r"><i class="fa fa-check"></i><b>1.3</b> Why <code>R</code>?</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#working-example-replicating-mankiw-romer-and-weils-1992-qje"><i class="fa fa-check"></i><b>1.4</b> Working Example: Replicating Mankiw, Romer and Weil’s 1992 QJE</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#the-way-forward"><i class="fa fa-check"></i><b>1.5</b> The way forward</a><ul>
<li class="chapter" data-level="" data-path="intro.html"><a href="intro.html#exercise-your-own-projects-steps"><i class="fa fa-check"></i>Exercise: Your own project’s steps</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="part-i.html"><a href="part-i.html"><i class="fa fa-check"></i>PART I</a></li>
<li class="chapter" data-level="2" data-path="project-organization.html"><a href="project-organization.html"><i class="fa fa-check"></i><b>2</b> Project Organization</a><ul>
<li class="chapter" data-level="2.1" data-path="project-organization.html"><a href="project-organization.html#project-structure-i-separating-inputs-and-outputs"><i class="fa fa-check"></i><b>2.1</b> Project Structure I: Separating Inputs and Outputs</a><ul>
<li class="chapter" data-level="2.1.1" data-path="project-organization.html"><a href="project-organization.html#the-root-folder"><i class="fa fa-check"></i><b>2.1.1</b> The Root Folder</a></li>
<li class="chapter" data-level="2.1.2" data-path="project-organization.html"><a href="project-organization.html#the-src-folder"><i class="fa fa-check"></i><b>2.1.2</b> The <code>src</code> folder</a></li>
<li class="chapter" data-level="2.1.3" data-path="project-organization.html"><a href="project-organization.html#the-out-folder"><i class="fa fa-check"></i><b>2.1.3</b> The <code>out</code> folder</a></li>
<li class="chapter" data-level="2.1.4" data-path="project-organization.html"><a href="project-organization.html#the-log-folder"><i class="fa fa-check"></i><b>2.1.4</b> The <code>log</code> folder</a></li>
<li class="chapter" data-level="2.1.5" data-path="project-organization.html"><a href="project-organization.html#exploring-the-full-structure-of-the-mrw-replication-project"><i class="fa fa-check"></i><b>2.1.5</b> Exploring the Full Structure of the MRW Replication Project</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="project-organization.html"><a href="project-organization.html#project-structure-ii-separating-logical-chunks-of-the-project"><i class="fa fa-check"></i><b>2.2</b> Project Structure II: Separating Logical Chunks of the Project</a><ul>
<li class="chapter" data-level="2.2.1" data-path="project-organization.html"><a href="project-organization.html#exploring-the-structure-of-the-mrw-replication-subdirectories"><i class="fa fa-check"></i><b>2.2.1</b> Exploring the Structure of the MRW Replication Subdirectories</a></li>
<li class="chapter" data-level="" data-path="project-organization.html"><a href="project-organization.html#exercise-exploring-the-remaining-subdirectories"><i class="fa fa-check"></i>Exercise: Exploring the Remaining Subdirectories</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="project-organization.html"><a href="project-organization.html#project-structure-iii-separating-input-parameters-from-code"><i class="fa fa-check"></i><b>2.3</b> Project Structure III: Separating Input Parameters from Code</a><ul>
<li class="chapter" data-level="2.3.1" data-path="project-organization.html"><a href="project-organization.html#exploring-parameter-separation-in-the-mrw-replication-project"><i class="fa fa-check"></i><b>2.3.1</b> Exploring Parameter Separation in the MRW Replication Project</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html"><i class="fa fa-check"></i><b>3</b> Initial Steps with Snakemake</a><ul>
<li class="chapter" data-level="3.1" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#starting-a-research-project"><i class="fa fa-check"></i><b>3.1</b> Starting a Research Project</a></li>
<li class="chapter" data-level="3.2" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#the-beginning-of-a-snakefile"><i class="fa fa-check"></i><b>3.2</b> The Beginning of a Snakefile</a></li>
<li class="chapter" data-level="3.3" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#rule-structure"><i class="fa fa-check"></i><b>3.3</b> Rule Structure</a></li>
<li class="chapter" data-level="3.4" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#our-first-rule"><i class="fa fa-check"></i><b>3.4</b> Our First Rule</a><ul>
<li class="chapter" data-level="3.4.1" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#constructing-the-rule"><i class="fa fa-check"></i><b>3.4.1</b> Constructing the Rule</a></li>
<li class="chapter" data-level="3.4.2" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#analysing-output"><i class="fa fa-check"></i><b>3.4.2</b> Analysing Output</a></li>
<li class="chapter" data-level="" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#exercise-deleting-output"><i class="fa fa-check"></i>Exercise: Deleting Output</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#creating-a-second-rule"><i class="fa fa-check"></i><b>3.5</b> Creating a Second Rule</a><ul>
<li class="chapter" data-level="" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#exercise-creating-rules"><i class="fa fa-check"></i>Exercise: Creating Rules</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#clean-rules"><i class="fa fa-check"></i><b>3.6</b> Clean Rules</a><ul>
<li class="chapter" data-level="" data-path="initial-steps-with-snakemake.html"><a href="initial-steps-with-snakemake.html#exercise-creating-cleaning-rules"><i class="fa fa-check"></i>Exercise: Creating Cleaning Rules</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="pattern-rules.html"><a href="pattern-rules.html"><i class="fa fa-check"></i><b>4</b> Pattern Rules</a><ul>
<li class="chapter" data-level="4.1" data-path="pattern-rules.html"><a href="pattern-rules.html#where-we-are-now"><i class="fa fa-check"></i><b>4.1</b> Where we are now?</a></li>
<li class="chapter" data-level="4.2" data-path="pattern-rules.html"><a href="pattern-rules.html#wildcards"><i class="fa fa-check"></i><b>4.2</b> Wildcards</a></li>
<li class="chapter" data-level="4.3" data-path="pattern-rules.html"><a href="pattern-rules.html#the-expand-function"><i class="fa fa-check"></i><b>4.3</b> The <code>expand()</code> function</a><ul>
<li class="chapter" data-level="" data-path="pattern-rules.html"><a href="pattern-rules.html#exercise-exploring-the-expand-function-i"><i class="fa fa-check"></i>Exercise: Exploring the expand() function I</a></li>
<li class="chapter" data-level="" data-path="pattern-rules.html"><a href="pattern-rules.html#exercise-exploring-the-expand-function-ii"><i class="fa fa-check"></i>Exercise: Exploring the expand function II</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="pattern-rules.html"><a href="pattern-rules.html#expanding-multiple-wildcards"><i class="fa fa-check"></i><b>4.4</b> Expanding Multiple Wildcards</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="wildcards-1.html"><a href="wildcards-1.html"><i class="fa fa-check"></i><b>5</b> Wildcards</a></li>
<li class="chapter" data-level="6" data-path="adding-parameters.html"><a href="adding-parameters.html"><i class="fa fa-check"></i><b>6</b> Adding Parameters</a></li>
<li class="chapter" data-level="7" data-path="an-all-rule.html"><a href="an-all-rule.html"><i class="fa fa-check"></i><b>7</b> An <code>all</code> Rule</a></li>
<li class="chapter" data-level="8" data-path="logging-output-and-errors.html"><a href="logging-output-and-errors.html"><i class="fa fa-check"></i><b>8</b> Logging Output and Errors</a></li>
<li class="chapter" data-level="9" data-path="self-documenting-help.html"><a href="self-documenting-help.html"><i class="fa fa-check"></i><b>9</b> Self Documenting Help</a></li>
<li class="chapter" data-level="10" data-path="config-files.html"><a href="config-files.html"><i class="fa fa-check"></i><b>10</b> Config Files</a></li>
<li class="chapter" data-level="11" data-path="subworkflows-divide-and-conquer.html"><a href="subworkflows-divide-and-conquer.html"><i class="fa fa-check"></i><b>11</b> Subworkflows: Divide and Conquer</a></li>
<li class="chapter" data-level="" data-path="part-ii.html"><a href="part-ii.html"><i class="fa fa-check"></i>PART II</a></li>
<li class="chapter" data-level="12" data-path="reproducible-articles-with-rmd.html"><a href="reproducible-articles-with-rmd.html"><i class="fa fa-check"></i><b>12</b> Reproducible Articles with Rmd</a></li>
<li class="chapter" data-level="13" data-path="reproducible-slides-with-rmd.html"><a href="reproducible-slides-with-rmd.html"><i class="fa fa-check"></i><b>13</b> Reproducible Slides with Rmd</a></li>
<li class="chapter" data-level="14" data-path="package-dependencies-with-packrat.html"><a href="package-dependencies-with-packrat.html"><i class="fa fa-check"></i><b>14</b> Package Dependencies with Packrat</a></li>
<li class="chapter" data-level="15" data-path="containers.html"><a href="containers.html"><i class="fa fa-check"></i><b>15</b> Containers</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Reproducible Research Workflows with Snakemake and <code>R</code></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="initial-steps-with-snakemake" class="section level1">
<h1><span class="header-section-number">Chapter 3</span> Initial Steps with Snakemake</h1>
<div id="starting-a-research-project" class="section level2">
<h2><span class="header-section-number">3.1</span> Starting a Research Project</h2>
<p>We are now ready to get started working with the code and data to build a fully reproducible pipeline. In Chapter XX we described a simplified research workflow to be:</p>
<ol style="list-style-type: decimal">
<li>Perform some data management</li>
<li>Do some analysis</li>
<li>Turn the output of the analysis into a tabular format</li>
<li>Construct a set of graphs</li>
<li>Integrate the tables and graphs into a paper and a set of slides (optional)</li>
</ol>
<p>We are going to start at the beginning with data management.</p>
<p>Recall that we have the following files in our data management subdirectory, <code>src/data-management</code>:</p>
<pre class="out"><code>rename_variables.R
gen_reg_vars.R</code></pre>
<p>We will need to run each of these scripts sequentially. First we want to run the script <code>rename_variables.R</code> to tidy up the variable names in our data set. Second, <code>gen_reg_vars.R</code> will create the some additional variables in our data that will be needed to run some regressions in later steps. Over the next few sections we are going to build up 2 <strong>rules</strong>, one for each file, that will execute these scripts and deliver output.</p>
</div>
<div id="the-beginning-of-a-snakefile" class="section level2">
<h2><span class="header-section-number">3.2</span> The Beginning of a Snakefile</h2>
<p>We are going to put the collection of rules that build our project into a file. We can then use the <code>Snakemake</code> to execute these rules and build our project. The set of rules we want to construct are going to go into the file called <code>Snakefile</code> - which is the name of a file that Snakemake will look into by default to execite a project. Lets open the file called <code>Snakefile</code> in the project’s main directory. When you open it it should look as follows:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Main Workflow - SOME PROJECT</span>
<span class="co">#</span>
<span class="co"># Contributors: YOUR NAME(S)</span></code></pre></div>
<p>Note that the amount of structure we have here is not totally necessary. However, good structure will make understanding easier later. Let’s go through what we see. The first lines of code are comments, to help us navigate a little and understand what we are looking at. The very first line tells us that this is a project workflow, and then tells us what the particular project is. The second line tells us who contributed to this file. This can be useful so we know who to contact with questions. You should do update the name of the project, and add your name to the list of contributors. For us, the top 2 lines becomes:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Main Workflow - MRW Replication</span>
<span class="co">#</span>
<span class="co"># Contributors: @lachlandeer, @julianlanger</span></code></pre></div>
<p>The next few lines are:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># --- Main Build Rules --- #</span>
<span class="co">## To be constructed</span></code></pre></div>
<p>These are more comments. We are using the <code># --- Something --- #</code> notation to break up the code into logical blocks. It is in this block that we will assemble the rules on which our project will be built.</p>
</div>
<div id="rule-structure" class="section level2">
<h2><span class="header-section-number">3.3</span> Rule Structure</h2>
<p>A <code>Snakefile</code> is a collection of rules that together define the order in which a project will be executed. In our <code>Snakefile</code> we will start to assemble rules under the <code># --- Main Build Rules --- #</code> section to keep things tidy. Each rule can be thought of as a recipe that combines different <strong>inputs</strong>, such as data and and R script together to produce one or more <strong>output(s)</strong>. The key components we are going to use to construct a rule are:</p>
<ol style="list-style-type: lower-roman">
<li>a name for the rule,</li>
<li>the list of inputs</li>
<li>the list of outputs produced</li>
<li>a shell command that tells snakemake how to combine the inputs to produce a outputs.</li>
</ol>
<p><code>Snakemake</code> expects these components to be provided in a particular way so that it knows what to do with the information you provided. We are going to specify rules in the following format:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">rule</span> rule_name:
    <span class="kw">input</span>:
        <span class="kw">input_name1</span> = <span class="st">&quot;PATH/TO/input_one&quot;</span>,
        <span class="kw">input_name2</span> = <span class="st">&quot;PATH/TO/input_two&quot;</span>
    <span class="kw">output</span>:
        <span class="kw">output_name1</span> = <span class="st">&quot;PATH/TO/SAVE/output_one&quot;</span>,
        <span class="kw">output_name2</span> = <span class="st">&quot;PATH/TO/SAVE/output_two&quot;</span>
    <span class="kw">shell</span>:
        <span class="st">&quot;HOW TO MIX IT ALL TOGETHER&quot;</span></code></pre></div>
<p>We can have as many inputs and outputs as we need to have per rule. Each input and each output are given names, for example <code>input_name1</code> which take the value to the file path and name of the file. It is important to wrap each of these paths into quotations, and to separate each of the multiple inputs and outputs with a comma.</p>
</div>
<div id="our-first-rule" class="section level2">
<h2><span class="header-section-number">3.4</span> Our First Rule</h2>
<div id="constructing-the-rule" class="section level3">
<h3><span class="header-section-number">3.4.1</span> Constructing the Rule</h3>
<p>As mentioned above, we will start with the data management step.</p>
<p>First script to run is <code>rename_variables.R</code> which is located in the data management subdirectory. This is a simple script that renames some variables for us to be easier to understand.</p>
<p>We can then start our snakemake script by adding this script as an input:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">rule</span> rule_name:
    <span class="kw">input</span>:
        <span class="kw">script</span> = <span class="st">&quot;src/data-management/rename_variables.R&quot;</span>,
        <span class="kw">input_name2</span> = <span class="st">&quot;PATH/TO/input_two&quot;</span>
    <span class="kw">output</span>:
        <span class="kw">output_name1</span> = <span class="st">&quot;PATH/TO/SAVE/output_one&quot;</span>,
        <span class="kw">output_name2</span> = <span class="st">&quot;PATH/TO/SAVE/output_two&quot;</span>
    <span class="kw">shell</span>:
        <span class="st">&quot;HOW TO MIX IT ALL TOGETHER&quot;</span></code></pre></div>
<p>Next, we want to add any additional inputs and also specify any outputs that the file produces. We have set up all R scripts in this example to provide us with ‘help’ so that we know what we might need to add. To find out what inputs are required and what outputs are produced, we use the <code>--help</code> flag when calling the file with <code>R</code>:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">Rscript</span> src/data-management/rename_variables.R --help</code></pre></div>
<p>And the following output is produced:</p>
<pre class="out"><code>Usage: src/data-management/rename_variables.R [options]


Options:
    -d CHARACTER, --data=CHARACTER
        stata dataset file name

    -o CHARACTER, --out=CHARACTER
        output file name [default = out.csv]

    -h, --help
        Show this help message and exit</code></pre>
<p>This suggests the script needs …</p>
<p>We update our <code>rename_variables</code> as:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">rule</span> rename_vars:
    <span class="kw">input</span>:
        <span class="kw">script</span> = <span class="st">&quot;src/data-management/rename_variables.R&quot;</span>,
        <span class="kw">data</span>   = <span class="st">&quot;src/data/mrw.dta&quot;</span>
    <span class="kw">output</span>:
        <span class="kw">data</span> = <span class="st">&quot;out/data/mrw_renamed.csv&quot;</span>
    <span class="kw">shell</span>:
        <span class="st">&quot;HOW TO MIX IT ALL TOGETHER&quot;</span></code></pre></div>
<p>Next we provide a recipe telling snakemake how to mix the inputs to create the outputs:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">rule</span> rename_vars:
    <span class="kw">input</span>:
        <span class="kw">script</span> = <span class="st">&quot;src/data-management/rename_variables.R&quot;</span>,
        <span class="kw">data</span>   = <span class="st">&quot;src/data/mrw.dta&quot;</span>
    <span class="kw">output</span>:
        <span class="kw">data</span> = <span class="st">&quot;out/data/mrw_renamed.csv&quot;</span>
    <span class="kw">shell</span>:
        <span class="st">&quot;Rscript {input.script} \</span>
<span class="st">            --data {input.data} \</span>
<span class="st">            --out {output.data}&quot;</span></code></pre></div>
<p>We can now try and run snakemake to execute this rule …</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">snakemake</span></code></pre></div>
<p>Stuff happens …</p>
</div>
<div id="analysing-output" class="section level3">
<h3><span class="header-section-number">3.4.2</span> Analysing Output</h3>
<p>We can look into our output directory to see if anything has happened:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">ls</span> out/data/</code></pre></div>
<p>which yields</p>
<pre class="out"><code>mrw_renamed.csv</code></pre>
<p>Our file has been created as we expected.</p>
<p>Try and run snakemake again</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">snakemake</span></code></pre></div>
<p>and we see the following output:</p>
<pre class="out"><code>Building DAG of jobs...
Nothing to be done.</code></pre>
<p>Why?</p>
<p>Snakemake provides the a <em>summary</em> option which tells us what is going on:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">snakemake</span> --summary</code></pre></div>
<p>The output is:</p>
<pre class="out"><code>Building DAG of jobs...
output_file                       date                    rule      version  log-file(s)    status  plan
out/data/mrw_renamed.csv    Thu Jan 10 20:31:08 2019    rename_vars    -                     ok     no update
</code></pre>
<p>Explain what this tells us …</p>
<p>Suppose we updated one of the inputs …</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">touch</span> src/data-management/rename_variables.R</code></pre></div>
<p>and then look at the summary from snakemake:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">snakemake</span></code></pre></div>
<pre class="out"><code>Building DAG of jobs...
output_file                        date                    rule     version log-file(s)      status                plan
out/data/mrw_renamed.csv    Thu Jan 10 20:31:08 2019    rename_vars    -                updated input files update pending</code></pre>
<p>What this means?</p>
<p>Run snakemake to build the output:</p>
<pre><code>snakemake</code></pre>
</div>
<div id="exercise-deleting-output" class="section level3 unnumbered exercise">
<h3>Exercise: Deleting Output</h3>
<p>Delete the output <code>out/data/mrw_renamed.csv</code>. Run <code>snakemake --summary</code> and explain the output it produced.</p>
</div>
</div>
<div id="creating-a-second-rule" class="section level2">
<h2><span class="header-section-number">3.5</span> Creating a Second Rule</h2>
<p>The second step in our data management is to create some variables we will use in our regression analysis. The script <code>gen_reg_vars.R</code> in the <code>src/data-management</code> folder does this for us. We are going to build a rule called <code>gen_regression_vars</code> to do this in Snakemake. Let’s see what the script expects to be passed:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">Rscript</span> src/data-management/gen_reg_vars.R --help</code></pre></div>
<pre class="out"><code>Usage: src/data-management/gen_reg_vars.R [options]


Options:
    -d CHARACTER, --data=CHARACTER
        a csv file name

    -p CHARACTER, --param=CHARACTER
        a file name containing model parameters

    -o CHARACTER, --out=CHARACTER
        output file name [default = out.csv]

    -h, --help
        Show this help message and exit
</code></pre>
<p>So we need to provide:</p>
<p>to provide the output …</p>
<p>Let’s create this rule:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">rule</span> gen_regression_vars:
    <span class="kw">input</span>:
        <span class="kw">script</span> = <span class="st">&quot;src/data-management/gen_reg_vars.R&quot;</span>,
        <span class="kw">data</span>   = <span class="st">&quot;out/data/mrw_renamed.csv&quot;</span>,
        <span class="kw">params</span> = <span class="st">&quot;src/data-specs/param_solow.json&quot;</span>,
    <span class="kw">output</span>:
        <span class="kw">data</span> = <span class="st">&quot;out/data/mrw_complete.csv&quot;</span>
    <span class="kw">shell</span>:
        <span class="st">&quot;Rscript {input.script} \</span>
<span class="st">            --data {input.data} \</span>
<span class="st">            --param {input.params} \</span>
<span class="st">            --out {output.data}&quot;</span></code></pre></div>
<p>What will Snakemake want to do next? Let’s use the summary option to see …</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">snakemake</span> --summary</code></pre></div>
<pre class="out"><code>Building DAG of jobs...
output_file                    date                     rule                  version   log-file(s) status     plan
out/data/mrw_complete.csv   -                           gen_regression_vars     -                   missing update pending
out/data/mrw_renamed.csv    Fri Jan 11 13:40:07 2019    rename_vars             -                   ok          no update</code></pre>
<p>Explain what this means</p>
<p>Let’s run snakemake to build our new file:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">snakemake</span></code></pre></div>
<p>When we look at our output directory:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">ls</span> out/data/</code></pre></div>
<pre class="out"><code>mrw_complete.csv  mrw_renamed.csv</code></pre>
<p>So we see that our data set has been built.</p>
<div id="exercise-creating-rules" class="section level3 unnumbered exercise">
<h3>Exercise: Creating Rules</h3>
<p>The MRW paper estimates the Solow model for three subsets of data. You need to create rules to do estimate the Solow model for each of these data sets. The R script <code>src/analysis/estimate_ols.R</code> will estimate a OLS model for a given dataset when you provide the necessary inputs.</p>
<ol style="list-style-type: decimal">
<li>What inputs do you need to provide?</li>
<li>What outputs will be produced?</li>
<li>Write Snakemake rules to estimate the solow model for each subset of data.</li>
</ol>
</div>
</div>
<div id="clean-rules" class="section level2">
<h2><span class="header-section-number">3.6</span> Clean Rules</h2>
<p>So far, we have built up our Snakefile to:</p>
<ol style="list-style-type: decimal">
<li>Clean data</li>
<li>Run a regression model on different subsets of data</li>
</ol>
<p>As we continue to extend our Snakefile in the coming chapters we might want to be able to delete all of the produced outputs, and see if we can rebuild our project from the first step. One way to do this would be to go to our terminal window and enter the following command each time:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">rm</span> -rf out/*</code></pre></div>
<p>Instead of doing this each time, we can integrate this <em>cleaning</em> of computer produced outputs into our Snakefile. We can create a rule called <code>clean</code> that stores the shell command from above:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">rule</span> clean:
    <span class="kw">shell</span>:
        <span class="st">&quot;rm -rf out/*&quot;</span></code></pre></div>
<p>Note that this rule has no inputs or outputs.</p>
<p>To use this rule, we enter the following into our terminal:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">snakemake</span> clean</code></pre></div>
<p>Notice that to use the clean rule we had to call the rule name, clean, explicitly.</p>
<p>Now if we look out the output of running the summary call with snakemake, we see the following output:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">snakemake</span> --summary</code></pre></div>
<pre class="out"><code>Building DAG of jobs...
output_file                                        date   rule  version log-file(s)     status  plan
out/analysis/model_solow_subset_intermediate.rds    -     inter        -                missing update pending
out/analysis/model_solow_subset_nonoil.rds          -     nonoil       -                missing update pending
out/analysis/model_solow_subset_oecd.rds            -     oecd         -                missing update pending
out/data/mrw_complete.csv                           -     gen_regression_vars           missing update pending
out/data/mrw_renamed.csv                            -     rename_vars                   missing update pending</code></pre>
<p>Which reveals snakemake’s plan the next time its run will be to build all outputs.</p>
<div id="exercise-creating-cleaning-rules" class="section level3 unnumbered exercise">
<h3>Exercise: Creating Cleaning Rules</h3>
<p>So far we have written a cleaning rule that deletes everything in the <code>out/</code> directory. Construct rules that would separately clean the <code>out/data/</code> and <code>out/analysis</code> subdirectories. Why might we want to do this?</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="project-organization.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="pattern-rules.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/03-inital_steps.Rmd",
"text": "Edit"
},
"download": ["book.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
